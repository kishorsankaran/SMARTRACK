<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMARTRACK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom styles can be added here or in a separate file if preferred, but Tailwind is primary */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background-color: #1f2937;
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        .tab-button {
            padding: 10px 15px;
            border: none;
            background-color: #e5e7eb;
            cursor: pointer;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin-right: 5px;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #4b5563;
        }
        .tab-button:hover {
            background-color: #d1d5db;
        }
        .tab-button.active {
            background-color: #fff;
            border-bottom: 2px solid #3b82f6;
            color: #1f2937;
            font-weight: 600;
        }
        .page-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .form-section {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.2s ease-in-out;
            background-color: #fff;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
        }
        .action-button {
            background-color: #3b82f6;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .action-button:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }
        .action-button:active {
            transform: translateY(0);
        }
        .secondary-button {
            background-color: #6b7280;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-left: 10px;
        }
        .secondary-button:hover {
            background-color: #4b5563;
            transform: translateY(-1px);
        }
        .secondary-button:active {
            transform: translateY(0);
        }
        .danger-button {
            background-color: #ef4444;
            color: #fff;
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .danger-button:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }
        .edit-button {
            background-color: #10b981;
            color: #fff;
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .edit-button:hover {
            background-color: #059669;
            transform: translateY(-1px);
        }
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 12px 15px;
            text-align: left;
            white-space: nowrap;
        }
        th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            font-size: 14px;
        }
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        tr:hover {
            background-color: #f0f4f8;
        }
        .action-buttons button {
            margin-right: 5px;
        }
        .hidden {
            display: none !important;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .modal-content h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #1f2937;
        }
        .modal-content p {
            font-size: 16px;
            color: #4b5563;
            margin-bottom: 25px;
        }
        .modal-buttons button {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 10px;
            transition: background-color 0.3s ease;
        }
        .modal-buttons .confirm-yes {
            background-color: #3b82f6;
            color: #fff;
            border: none;
        }
        .modal-buttons .confirm-yes:hover {
            background-color: #2563eb;
        }
        .modal-buttons .confirm-no {
            background-color: #e5e7eb;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }
        .modal-buttons .confirm-no:hover {
            background-color: #d1d5db;
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            font-size: 1.5rem;
            text-align: center;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Auth Container Specific Styles */
        #authContainer {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f3f4f6;
            width: 100%;
            align-items: stretch;
        }

        @media (min-width: 768px) {
            #authContainer {
                flex-direction: row;
            }
            .auth-left-pane {
                display: flex !important;
                width: 50%;
            }
            .auth-right-pane {
                width: 50%;
            }
        }

        .auth-left-pane {
            display: none;
            background-color: #1f2937;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }
        .auth-left-pane h1 {
            font-size: 3.5rem;
            font-weight: 800;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
        }

        .auth-right-pane {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            flex-grow: 1;
        }
        @media (min-width: 768px) {
            .auth-right-pane {
                padding: 2rem;
            }
        }

        .auth-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 320px;
            text-align: center;
        }
        .auth-card h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1f2937;
        }
        .auth-card .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .auth-card input[type="email"],
        .auth-card input[type="password"] {
            padding: 8px 12px;
        }
        .auth-card button {
            width: 100%;
            margin-top: 15px;
            padding: 8px 15px;
        }
        .auth-card .toggle-mode-link {
            margin-top: 15px;
            font-size: 0.875rem;
            color: #6b7280;
        }
        .status-indicators {
            margin-top: 15px;
            font-size: 0.8rem;
            color: #555;
            text-align: left;
            padding: 10px;
            display: none;
        }
        .status-indicators span {
            display: block;
            margin-bottom: 3px;
        }
        .status-indicators .ok {
            color: #10b981;
        }
        .status-indicators .error {
            color: #ef4444;
        }
        
        /* New custom style for the email modal */
        #emailModal .modal-content {
            max-width: 500px;
            text-align: left;
        }
        .email-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
        }
        .email-list label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .email-list input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .upload-file-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .upload-file-button {
            background-color: #1c64f2;
            color: #fff;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .upload-file-button:hover {
            background-color: #1a56c4;
        }

        .upload-file-info {
            font-size: 12px;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loadingOverlay" class="hidden">
        <div class="flex flex-col items-center">
            <div class="spinner"></div>
            <span id="loadingMessage">Loading...</span>
        </div>
    </div>

    <div id="messageModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="messageModalTitle"></h3>
            <p id="messageModalMessage"></p>
            <div class="modal-buttons">
                <button class="action-button" onclick="hideMessageModal()">OK</button>
            </div>
        </div>
    </div>

    <div id="customConfirmModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="customConfirmTitle">Confirm Action</h3>
            <p id="customConfirmMessage"></p>
            <div class="modal-buttons">
                <button class="confirm-yes action-button" onclick="handleCustomConfirm(true)">Yes</button>
                <button class="confirm-no secondary-button" onclick="handleCustomConfirm(false)">No</button>
            </div>
        </div>
    </div>
    
    <div id="forgotPasswordModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-semibold mb-4 text-gray-700">Reset Password</h3>
            <p class="text-gray-600 mb-6">Enter your email address to receive a password reset link.</p>
            <div class="form-group">
                <label for="resetEmail" class="sr-only">Email</label>
                <input type="email" id="resetEmail" placeholder="your.email@example.com" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button type="button" class="action-button" onclick="sendPasswordReset()">Send Reset Email</button>
                <button type="button" class="secondary-button" onclick="hideForgotPasswordModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="emailModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="emailModalTitle" class="text-2xl font-semibold mb-4 text-gray-700">Send Email</h3>
            <p id="emailModalMessage" class="text-gray-600 mb-4">Select staff to email the document details.</p>
            
            <div class="form-group">
                <label class="block font-medium mb-2">Recipients:</label>
                <div id="staffEmailCheckboxes" class="email-list">
                    </div>
            </div>
            <p class="text-sm text-gray-500 mt-2">Note: This will open a new Outlook email draft with a summary of the document details. The document itself is not attached or linked.</p>
            
            <div class="flex justify-end space-x-2 mt-6">
                <button type="button" class="action-button" id="sendEmailButton" onclick="sendEmailViaOutlook()">Send via Outlook</button>
                <button type="button" class="secondary-button" onclick="hideEmailModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="authContainer">
        <div class="auth-left-pane">
            <h1>SMARTRACK</h1>
            <img src="https://raw.githubusercontent.com/kishorsankaran/SMARTTRACK/main/my_logo.png" alt="Company Logo" class="w-36 h-36 object-contain mx-auto mt-4">
        </div>
        <div class="auth-right-pane">
            <div class="auth-card">
                <h2 id="authTitle">Sign In</h2>
                <div class="form-group">
                    <label for="authEmail">Email:</label>
                    <input type="email" id="authEmail" placeholder="your.email@example.com">
                </div>
                <div class="form-group">
                    <label for="authPassword">Password:</label>
                    <input type="password" id="authPassword" placeholder="••••••••">
                </div>
                <button id="authSubmitButton" class="action-button" onclick="handleAuthSubmit()">Sign In</button>
                <p class="toggle-mode-link">
                    Don't have an account? <button onclick="toggleAuthMode()" class="text-blue-600 hover:underline">Sign Up</button>
                </p>
                <p class="mt-4 text-sm">
                    <button onclick="showForgotPasswordModal()" class="text-blue-600 hover:underline">Forgot Password?</button>
                </p>
                <div class="status-indicators">
                    <p>Application Status:</p>
                    <span>User ID: <span id="displayUserId">N/A</span></span>
                    <span>App ID: <span id="appIdStatus">N/A</span></span>
                    <span>Firebase Config: <span id="firebaseConfigStatus">N/A</span></span>
                    <p class="text-sm text-gray-500 mt-2">For persistent data, please ensure Firebase is correctly configured and authenticated.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="appContainer" class="container hidden">
        <header class="header">
            <h1 class="text-3xl font-bold">Document Control Register</h1>
            <div class="flex items-center">
                <span id="displayUserId" class="text-sm font-medium mr-4"></span>
                <button onclick="handleSignOut()" class="secondary-button">Sign Out</button>
            </div>
        </header>

        <nav class="tab-buttons">
            <button class="tab-button active" onclick="showPage('inspectionsPage')">Inspections Register</button>
            <button class="tab-button" onclick="showPage('mirPage')">MIR Register</button>
            <button class="tab-button" onclick="showPage('ncrPage')">NCR Register</button>
            <button class="tab-button" onclick="showPage('submissionPage')">Submission Register</button>
            <button class="tab-button" onclick="showPage('correspondencePage')">Correspondence Register</button>
            <button class="tab-button" onclick="showPage('staffEmailsPage')">Staff Emails</button>
        </nav>

        <div id="inspectionsPage" class="page-content">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Inspections Register</h2>

            <div class="form-section">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Add/Edit Inspection</h3>
                <form id="inspectionForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="date">Date:</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="discipline">Discipline:</label>
                        <select id="discipline" required>
                            <option value="">--Select--</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="insNumber">INS Number:</label>
                        <input type="text" id="insNumber" placeholder="e.g., CP837-INS-CIV-0001" required>
                        <span class="text-xs text-gray-500 mt-1">Next: <span id="nextInsNumber">Loading...</span></span>
                    </div>
                    <div class="form-group">
                        <label for="revision">Revision:</label>
                        <input type="text" id="revision" placeholder="e.g., 0, 1, A" required>
                    </div>
                    <div class="form-group">
                        <label for="location">Location:</label>
                        <input type="text" id="location" placeholder="e.g., Area 1">
                    </div>
                    <div class="form-group">
                        <label for="workToBeInspected">Work To Be Inspected:</label>
                        <textarea id="workToBeInspected" rows="2" placeholder="Description of work"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="inspectionDate">Inspection Date:</label>
                        <input type="date" id="inspectionDate">
                    </div>
                    <div class="form-group">
                        <label for="inspectionTime">Inspection Time:</label>
                        <input type="time" id="inspectionTime">
                    </div>
                    <div class="form-group">
                        <label for="approvedDrawingRef">Approved Drawing Ref.:</label>
                        <input type="text" id="approvedDrawingRef" placeholder="e.g., DWG-001">
                    </div>
                    <div class="form-group">
                        <label for="specificationRef">Specification Ref.:</label>
                        <input type="text" id="specificationRef" placeholder="e.g., SPE-001">
                    </div>
                    <div class="form-group">
                        <label for="approvedMethodStatementRef">Approved Method Statement Ref.:</label>
                        <input type="text" id="approvedMethodStatementRef" placeholder="e.g., MST-001">
                    </div>
                    <div class="form-group">
                        <label for="qcsReference">QCS Reference:</label>
                        <input type="text" id="qcsReference" placeholder="e.g., QCS-2014">
                    </div>
                    <div class="form-group">
                        <label for="commentReceivedDate">Comment Received Date:</label>
                        <input type="date" id="commentReceivedDate">
                    </div>
                    <div class="form-group">
                        <label for="documentStatus">Document Status:</label>
                        <select id="documentStatus" required>
                            <option value="">--Select--</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="revStatus">Lifecycle Status:</label>
                        <input type="text" id="revStatus" readonly class="bg-gray-100 text-gray-500">
                    </div>
                    <div class="form-group">
                        <label for="inspectionDocument">Upload Document:</label>
                        <input type="file" id="inspectionDocument">
                    </div>
                    <div class="form-group col-span-full flex justify-end space-x-2">
                        <button type="button" id="addUpdateButton" class="action-button" onclick="addUpdateInspectionDocument()">Add Document</button>
                        <button type="button" class="secondary-button" onclick="clearInspectionsForm()">Clear Form</button>
                    </div>
                </form>
            </div>

            <div class="table-section mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">All Inspections</h3>
                    <div class="flex space-x-2">
                        <button class="secondary-button" id="toggleInspectionsTableBtn" onclick="toggleTableVisibility('inspectionsTableContainer', 'toggleInspectionsTableBtn')">Hide Table</button>
                        <button class="action-button" onclick="downloadInspectionsCSV()">Download CSV</button>
                    </div>
                </div>

                <div class="flex flex-wrap items-end gap-4 mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="form-group m-0 flex-grow">
                        <label for="inspectionsSearchField" class="text-sm">Search Field:</label>
                        <select id="inspectionsSearchField" class="w-full">
                            <option value="">All Fields</option>
                            <option value="date">Date</option>
                            <option value="discipline">Discipline</option>
                            <option value="ins_number">INS Number</option>
                            <option value="revision">Revision</option>
                            <option value="location">Location</option>
                            <option value="work_to_be_inspected">Work To Be Inspected</option>
                            <option value="inspection_date">Inspection Date</option>
                            <option value="inspection_time">Inspection Time</option>
                            <option value="approved_drawing_ref">Approved Drawing Ref.</option>
                            <option value="specification_ref">Specification Ref.</option>
                            <option value="approved_method_statement_ref">Approved Method Statement Ref.</option>
                            <option value="qcs_reference">QCS Reference</option>
                            <option value="comment_received_date">Comment Received Date</option>
                            <option value="document_status">Document Status</option>
                            <option value="rev_status">Lifecycle Status</option>
                            <option value="approval_summary_status">Approval Summary</option>
                        </select>
                    </div>
                    <div class="form-group m-0 flex-grow-[2]">
                        <label for="inspectionsSearchTerm" class="text-sm">Search Term:</label>
                        <input type="text" id="inspectionsSearchTerm" placeholder="Enter search term" class="w-full">
                    </div>
                    <div class="flex space-x-2">
                        <button class="action-button" onclick="performInspectionsSearch()"><i class="fas fa-search"></i> Search</button>
                        <button class="secondary-button" onclick="clearInspectionsSearch()"><i class="fas fa-redo"></i> Reset</button>
                    </div>
                </div>

                <div id="inspectionsTableContainer" class="table-container">
                    <table id="inspectionsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Discipline</th>
                                <th>INS No.</th>
                                <th>Rev.</th>
                                <th>Location</th>
                                <th>Work to be Inspected</th>
                                <th>Insp. Date</th>
                                <th>Insp. Time</th>
                                <th>Appr. Drawing Ref.</th>
                                <th>Spec. Ref.</th>
                                <th>Appr. MS Ref.</th>
                                <th>QCS Ref.</th>
                                <th>Comment Rec. Date</th>
                                <th>Doc. Status</th>
                                <th>Lifecycle Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="mirPage" class="page-content hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Material Inspection Request (MIR) Register</h2>

            <div class="form-section">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Add/Edit MIR</h3>
                <form id="mirForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="mirDate">MIR Date:</label>
                        <input type="date" id="mirDate" required>
                    </div>
                    <div class="form-group">
                        <label for="mirDiscipline">Discipline:</label>
                        <select id="mirDiscipline" required>
                            <option value="">--Select--</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mirNumber">MIR Number:</label>
                        <input type="text" id="mirNumber" placeholder="e.g., CP837-MIR-CIV-0001" required>
                        <span class="text-xs text-gray-500 mt-1">Next: <span id="nextMirNumber">Loading...</span></span>
                    </div>
                    <div class="form-group">
                        <label for="mirRevision">Revision:</label>
                        <input type="text" id="mirRevision" placeholder="e.g., 0, 1, A" required>
                    </div>
                    <div class="form-group">
                        <label for="dateMaterialReceived">Date Material Received:</label>
                        <input type="date" id="dateMaterialReceived">
                    </div>
                    <div class="form-group">
                        <label for="mirInspectionDate">MIR Inspection Date:</label>
                        <input type="date" id="mirInspectionDate">
                    </div>
                    <div class="form-group">
                        <label for="mirInspectionTime">MIR Inspection Time:</label>
                        <input type="time" id="mirInspectionTime">
                    </div>
                    <div class="form-group">
                        <label for="materialApprovalRef">Material Approval Ref.:</label>
                        <input type="text" id="materialApprovalRef" placeholder="e.g., MAT-APP-001">
                    </div>
                    <div class="form-group">
                        <label for="descriptionMaterial">Description of Material:</label>
                        <textarea id="descriptionMaterial" rows="2" placeholder="Description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="deliveryNoteNumber">Delivery Note Number:</label>
                        <input type="text" id="deliveryNoteNumber" placeholder="e.g., DN-12345">
                    </div>
                    <div class="form-group">
                        <label for="manufacturer">Manufacturer:</label>
                        <input type="text" id="manufacturer" placeholder="e.g., Company A">
                    </div>
                    <div class="form-group">
                        <label for="supplier">Supplier:</label>
                        <input type="text" id="supplier" placeholder="e.g., Supplier X">
                    </div>
                    <div class="form-group">
                        <label for="countryOrigin">Country of Origin:</label>
                        <input type="text" id="countryOrigin" placeholder="e.g., China">
                    </div>
                    <div class="form-group">
                        <label for="mirSubmissionDate">MIR Submission Date:</label>
                        <input type="date" id="mirSubmissionDate">
                    </div>
                    <div class="form-group">
                        <label for="mirResponseDate">MIR Response Date:</label>
                        <input type="date" id="mirResponseDate">
                    </div>
                    <div class="form-group">
                        <label for="mirApprovalStatus">Approval Status:</label>
                        <select id="mirApprovalStatus" required>
                            <option value="">--Select--</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mirRevStatus">Lifecycle Status:</label>
                        <input type="text" id="mirRevStatus" readonly class="bg-gray-100 text-gray-500">
                    </div>
                    <div class="form-group">
                        <label for="mirDocument">Upload Document:</label>
                        <input type="file" id="mirDocument">
                    </div>
                    <div class="form-group col-span-full flex justify-end space-x-2">
                        <button type="button" id="addUpdateMirButton" class="action-button" onclick="addUpdateMirDocument()">Add Document</button>
                        <button type="button" class="secondary-button" onclick="clearMirForm()">Clear Form</button>
                    </div>
                </form>
            </div>

            <div class="table-section mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">All MIRs</h3>
                    <div class="flex space-x-2">
                        <button class="secondary-button" id="toggleMirTableBtn" onclick="toggleTableVisibility('mirTableContainer', 'toggleMirTableBtn')">Hide Table</button>
                        <button class="action-button" onclick="downloadMirCSV()">Download CSV</button>
                    </div>
                </div>

                <div class="flex flex-wrap items-end gap-4 mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="form-group m-0 flex-grow">
                        <label for="mirSearchField" class="text-sm">Search Field:</label>
                        <select id="mirSearchField" class="w-full">
                            <option value="">All Fields</option>
                            <option value="mir_date">MIR Date</option>
                            <option value="mir_discipline">Discipline</option>
                            <option value="mir_number">MIR Number</option>
                            <option value="mir_revision">Revision</option>
                            <option value="date_material_received">Date Material Received</option>
                            <option value="mir_inspection_date">MIR Inspection Date</option>
                            <option value="mir_inspection_time">MIR Inspection Time</option>
                            <option value="material_approval_ref">Material Approval Ref.</option>
                            <option value="description_material">Description of Material</option>
                            <option value="delivery_note_number">Delivery Note Number</option>
                            <option value="manufacturer">Manufacturer</option>
                            <option value="supplier">Supplier</option>
                            <option value="country_origin">Country of Origin</option>
                            <option value="mir_submission_date">MIR Submission Date</option>
                            <option value="mir_response_date">MIR Response Date</option>
                            <option value="mir_approval_status">Approval Status</option>
                            <option value="mir_rev_status">Lifecycle Status</option>
                            <option value="mir_approval_summary_status">Approval Summary</option>
                        </select>
                    </div>
                    <div class="form-group m-0 flex-grow-[2]">
                        <label for="mirSearchTerm" class="text-sm">Search Term:</label>
                        <input type="text" id="mirSearchTerm" placeholder="Enter search term" class="w-full">
                    </div>
                    <div class="flex space-x-2">
                        <button class="action-button" onclick="performMirSearch()"><i class="fas fa-search"></i> Search</button>
                        <button class="secondary-button" onclick="clearMirSearch()"><i class="fas fa-redo"></i> Reset</button>
                    </div>
                </div>

                <div id="mirTableContainer" class="table-container">
                    <table id="mirTable">
                        <thead>
                            <tr>
                                <th>MIR Date</th>
                                <th>Discipline</th>
                                <th>MIR No.</th>
                                <th>Rev.</th>
                                <th>Date Mat. Rec.</th>
                                <th>MIR Insp. Date</th>
                                <th>MIR Insp. Time</th>
                                <th>Mat. Appr. Ref.</th>
                                <th>Description of Material</th>
                                <th>Delivery Note No.</th>
                                <th>Manufacturer</th>
                                <th>Supplier</th>
                                <th>Country of Origin</th>
                                <th>MIR Sub. Date</th>
                                <th>MIR Resp. Date</th>
                                <th>Appr. Status</th>
                                <th>Lifecycle Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="ncrPage" class="page-content hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Non-Conformance Report (NCR) Register</h2>

            <div class="form-section">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Add/Edit NCR</h3>
                <form id="ncrForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <h4 class="col-span-full text-lg font-semibold text-blue-700 mt-2 mb-2">Part A: Non-Conformance Details</h4>
                    <div class="form-group">
                        <label for="ncrDiscipline">Discipline:</label>
                        <select id="ncrDiscipline" required onchange="autoFillNcrDetails()">
                            <option value="">--Select--</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ncrRefNumber">NCR Ref. Number:</label>
                        <input type="text" id="ncrRefNumber" placeholder="e.g., CP837-NCR-CIV-0001" required onchange="autoFillNcrDetails()">
                    </div>
                    <div class="form-group">
                        <label for="ncrDescription">NCR Description:</label>
                        <textarea id="ncrDescription" rows="2" placeholder="Describe the non-conformance"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="partAReceivedDate">Part A Received Date:</label>
                        <input type="date" id="partAReceivedDate">
                    </div>
                    <div class="form-group">
                        <label for="ncrDocument">Upload Document:</label>
                        <input type="file" id="ncrDocument">
                    </div>

                    <h4 class="col-span-full text-lg font-semibold text-blue-700 mt-4 mb-2">Part B: Root Cause & Corrective Action</h4>
                    <div class="form-group">
                        <label for="ncrRev_PartB">Part B Revision:</label>
                        <input type="text" id="ncrRev_PartB" placeholder="e.g., 0, 1, A" required readonly class="bg-gray-100 text-gray-500">
                    </div>
                    <div class="form-group">
                        <label for="ncrRevisedParts_PartB">Revised Parts (Part B):</label>
                        <input type="text" id="ncrRevisedParts_PartB" placeholder="e.g., Part A & B">
                    </div>
                    <div class="form-group">
                        <label for="immediateAction">Immediate Action:</label>
                        <textarea id="immediateAction" rows="2" placeholder="Action taken immediately"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="rootCause">Root Cause:</label>
                        <textarea id="rootCause" rows="2" placeholder="Identify the root cause"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="correctiveAction">Corrective Action:</label>
                        <textarea id="correctiveAction" rows="2" placeholder="Plan for corrective action"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="partBSubmittedDate">Part B Submitted Date:</label>
                        <input type="date" id="partBSubmittedDate">
                    </div>

                    <h4 class="col-span-full text-lg font-semibold text-blue-700 mt-4 mb-2">Part C: GEC Review</h4>
                    <div class="form-group">
                        <label for="partCReceivedDate">Part C Received Date:</label>
                        <input type="date" id="partCReceivedDate">
                    </div>
                    <div class="form-group">
                        <label for="partBAcceptedByGEC">Part B Accepted by GEC?:</label>
                        <select id="partBAcceptedByGEC">
                            <option value="">--Select--</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ifPartBAccepted">If Part B Accepted:</label>
                        <input type="text" id="ifPartBAccepted" readonly class="bg-gray-100 text-gray-500">
                    </div>

                    <h4 class="col-span-full text-lg font-semibold text-blue-700 mt-4 mb-2">Part D: Proposed Corrective Action Implementation</h4>
                    <div class="form-group">
                        <label for="partDRev">Part D Revision:</label>
                        <input type="text" id="partDRev" placeholder="e.g., 0, 1, A">
                    </div>
                    <div class="form-group">
                        <label for="partDRevisedParts">Revised Parts (Part D):</label>
                        <input type="text" id="partDRevisedParts" placeholder="e.g., Part A, B & D">
                    </div>
                    <div class="form-group">
                        <label for="partDSubmittedDate">Part D Submitted Date:</label>
                        <input type="date" id="partDSubmittedDate">
                    </div>

                    <h4 class="col-span-full text-lg font-semibold text-blue-700 mt-4 mb-2">Part E: Verification of Corrective Action Effectiveness</h4>
                    <div class="form-group">
                        <label for="partEReceivedDate">Part E Received Date:</label>
                        <input type="date" id="partEReceivedDate">
                    </div>
                    <div class="form-group">
                        <label for="partEStatus">Part E Status:</label>
                        <input type="text" id="partEStatus" placeholder="e.g., Closed, Verified">
                    </div>
                    <div class="form-group">
                        <label for="ncrCurrentStatus">NCR Current Status:</label>
                        <select id="ncrCurrentStatus">
                            <option value="">--Select--</option>
                        </select>
                    </div>

                    <div class="form-group col-span-full flex justify-end space-x-2">
                        <button type="button" id="addUpdateNcrButton" class="action-button" onclick="handleNcrFormSubmission()">Add Document</button>
                        <button type="button" class="secondary-button" onclick="clearNcrForm()">Clear Form</button>
                    </div>
                </form>
            </div>

            <div class="table-section mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">All NCRs</h3>
                    <div class="flex space-x-2">
                        <button class="secondary-button" id="toggleNcrTableBtn" onclick="toggleTableVisibility('ncrTableContainer', 'toggleNcrTableBtn')">Hide Table</button>
                        <button class="action-button" onclick="downloadNcrCSV()">Download CSV</button>
                    </div>
                </div>

                <div class="flex flex-wrap items-end gap-4 mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="form-group m-0 flex-grow">
                        <label for="ncrSearchField" class="text-sm">Search Field:</label>
                        <select id="ncrSearchField" class="w-full">
                            <option value="">All Fields</option>
                            <option value="ncr_ref_number">NCR Ref. Number</option>
                            <option value="ncr_discipline">Discipline</option>
                            <option value="ncr_lifecycle_status">Lifecycle Status</option>
                            <option value="ncr_description">NCR Description</option>
                            <option value="part_a_received_date">Part A Received Date</option>
                            <option value="ncr_rev_part_b">Part B Revision</option>
                            <option value="ncr_revised_parts_part_b">Revised Parts (Part B)</option>
                            <option value="immediate_action">Immediate Action</option>
                            <option value="root_cause">Root Cause</option>
                            <option value="corrective_action">Corrective Action</option>
                            <option value="part_b_submitted_date">Part B Submitted Date</option>
                            <option value="part_c_received_date">Part C Received Date</option>
                            <option value="part_b_accepted_by_gec">Part B Acc. by GEC?</option>
                            <option value="if_part_b_accepted">If Part B Accepted</option>
                            <option value="part_d_rev">Part D Revision</option>
                            <option value="part_d_revised_parts">Revised Parts (Part D)</option>
                            <option value="part_d_submitted_date">Part D Submitted Date</option>
                            <option value="part_e_received_date">Part E Received Date</option>
                            <option value="part_e_status">Part E Status</option>
                            <option value="ncr_current_status">NCR Current Status</option>
                        </select>
                    </div>
                    <div class="form-group m-0 flex-grow-[2]">
                        <label for="ncrSearchTerm" class="text-sm">Search Term:</label>
                        <input type="text" id="ncrSearchTerm" placeholder="Enter search term" class="w-full">
                    </div>
                    <div class="flex space-x-2">
                        <button class="action-button" onclick="performNcrSearch()"><i class="fas fa-search"></i> Search</button>
                        <button class="secondary-button" onclick="clearNcrSearch()"><i class="fas fa-redo"></i> Reset</button>
                    </div>
                </div>

                <div id="ncrTableContainer" class="table-container">
                    <table id="ncrTable">
                        <thead>
                            <tr>
                                <th>NCR Ref. No.</th>
                                <th>Discipline</th>
                                <th>Lifecycle Status</th>
                                <th>Description</th>
                                <th>Part A Rec. Date</th>
                                <th>Part B Rev.</th>
                                <th>Rev. Parts (B)</th>
                                <th>Imm. Action</th>
                                <th>Root Cause</th>
                                <th>Corr. Action</th>
                                <th>Part B Sub. Date</th>
                                <th>Part C Rec. Date</th>
                                <th>Part B Acc. by GEC?</th>
                                <th>If Part B Acc.</th>
                                <th>Part D Rev.</th>
                                <th>Rev. Parts (D)</th>
                                <th>Part D Sub. Date</th>
                                <th>Part E Rec. Date</th>
                                <th>Part E Status</th>
                                <th>Current Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="submissionPage" class="page-content hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Submission Register</h2>

            <div class="form-section">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Add/Edit Submission Document</h3>
                <form id="submissionForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="newDocNumber">Document Number:</label>
                        <input type="text" id="newDocNumber" placeholder="e.g., CP837-ENG-CIV-DRW-0001" required>
                    </div>
                    <div class="form-group">
                        <label for="newRev">Revision:</label>
                        <input type="text" id="newRev" placeholder="e.g., 0, A, B1" required>
                    </div>
                    <div class="form-group">
                        <label for="newDiscipline">Discipline:</label>
                        <select id="newDiscipline" required>
                            <option value="">--Select--</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newDocType">Document Type:</label>
                        <select id="newDocType" required>
                            <option value="">--Select--</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newSection">Section (Optional):</label>
                        <input type="text" id="newSection" placeholder="e.g., Foundations">
                    </div>
                    <div class="form-group">
                        <label for="newDocTitle">Document Title:</label>
                        <textarea id="newDocTitle" rows="2" placeholder="Full title of the document" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newSubRef">Submission Reference (Optional):</label>
                        <input type="text" id="newSubRef" placeholder="e.g., SUB-001">
                    </div>
                    <div class="form-group">
                        <label for="newSubmittedDate">Submitted Date:</label>
                        <input type="date" id="newSubmittedDate" required>
                    </div>
                    <div class="form-group">
                        <label for="gecDueDate">GEC Due Date (Auto):</label>
                        <input type="date" id="gecDueDate" readonly class="bg-gray-100 text-gray-500">
                    </div>
                    <div class="form-group">
                        <label for="newRespondedDate">Responded Date (Optional):</label>
                        <input type="date" id="newRespondedDate">
                    </div>
                    <div class="form-group">
                        <label for="newStatus">Status:</label>
                        <select id="newStatus">
                            <option value="">--Select--</option>
                            <option value="UR">UR - Under Review</option>
                            <option value="A">A - Approved as Submitted</option>
                            <option value="B">B - Approved with Comments</option>
                            <option value="C">C - Revised and Resubmit</option>
                            <option value="D">D - Returned</option>
                            <option value="E">E - For Information</option>
                            <option value="X">X - Cancelled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lifecycleStatus">Lifecycle Status:</label>
                        <input type="text" id="lifecycleStatus" readonly class="bg-gray-100 text-gray-500">
                    </div>
                    <div class="form-group">
                        <label for="daysOverdue">Days Overdue:</label>
                        <input type="text" id="daysOverdue" readonly class="bg-gray-100 text-gray-500">
                    </div>
                    <div class="form-group">
                        <label for="submissionDocument">Upload Document:</label>
                        <input type="file" id="submissionDocument">
                    </div>
                    <div class="form-group col-span-full flex justify-end space-x-2">
                        <button type="button" class="action-button" onclick="addNewSubmissionDocument()">Add Document</button>
                        <button type="button" class="secondary-button" onclick="clearNewSubmissionDocumentForm()">Clear Form</button>
                    </div>
                </form>
            </div>

            <div id="submissionTableContainer" class="table-section mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">All Submissions</h3>
                    <div class="flex space-x-2">
                        <button class="secondary-button" id="toggleSubmissionsTableBtn" onclick="toggleTableVisibility('submissionTableContainer', 'toggleSubmissionsTableBtn')">Hide Table</button>
                        <button class="action-button" onclick="downloadSubmissionCSV()">Download CSV</button>
                        <button class="secondary-button" onclick="showPivotTableOptions()">Show Pivot</button>
                    </div>
                </div>

                <div class="flex flex-wrap items-end gap-4 mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="form-group m-0 flex-grow">
                        <label for="submissionSearchInput" class="text-sm">Search All Fields:</label>
                        <input type="text" id="submissionSearchInput" placeholder="Enter search term" class="w-full">
                    </div>
                    <div class="form-group m-0">
                        <label for="statusFilter" class="text-sm">Filter by Status:</label>
                        <select id="statusFilter" onchange="filterSubmissionByStatus(this.value)" class="w-full">
                            <option value="">All Statuses</option>
                            <option value="UR">UR - Under Review</option>
                            <option value="A">A - Approved as Submitted</option>
                            <option value="B">B - Approved with Comments</option>
                            <option value="C">C - Revised and Resubmit</option>
                            <option value="D">D - Returned</option>
                            <option value="E">E - For Information</option>
                            <option value="X">X - Cancelled</option>
                        </select>
                    </div>
                    <div class="flex space-x-2">
                        <button class="action-button" onclick="searchSubmissionDocuments()"><i class="fas fa-search"></i> Search</button>
                        <button class="secondary-button" onclick="clearSubmissionSearch()"><i class="fas fa-redo"></i> Reset Filters</button>
                    </div>
                </div>

                <div id="submissionTableContainer" class="table-container">
                    <table id="submissionDocumentTable">
                        <thead>
                            <tr>
                                <th>Doc. No.</th>
                                <th>Rev.</th>
                                <th>Discipline</th>
                                <th>Doc. Type</th>
                                <th>Section</th>
                                <th>Doc. Title</th>
                                <th>Sub. Ref.</th>
                                <th>Submitted Date</th>
                                <th>GEC Due Date</th>
                                <th>Responded Date</th>
                                <th>Status</th>
                                <th>Lifecycle Status</th>
                                <th>Days Overdue</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="pivotTableContainer" class="form-section mt-8 hidden">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Submission Status Pivot Table</h3>
                <div class="form-group flex items-center gap-4 mb-4">
                    <label for="pivotGroupingSelect" class="font-medium">Group By:</label>
                    <select id="pivotGroupingSelect" onchange="generatePivotTable()" class="flex-grow">
                        <option value="discipline">Discipline</option>
                        <option value="doc_type">Document Type</option>
                        <option value="section">Section</option>
                    </select>
                    <button class="secondary-button" onclick="hidePivotTable()">Hide Pivot</button>
                    <button class="action-button" onclick="downloadPivotTableCSV()">Download Pivot CSV</button>
                </div>
                <div class="table-container">
                    <table id="pivotTable">
                        <thead>
                            </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="correspondencePage" class="page-content hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Correspondence Register</h2>

            <div class="flex tab-buttons mt-4">
                <button class="tab-button active" onclick="showCorrespondenceSection('outgoingCorrespondenceSection')">Outgoing</button>
                <button class="tab-button" onclick="showCorrespondenceSection('incomingCorrespondenceSection')">Incoming</button>
            </div>

            <div id="outgoingCorrespondenceSection" class="correspondence-section">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Add/Edit Outgoing Correspondence</h3>
                <form id="outgoingCorrespondenceForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="newOutgoingInitiator">Initiator:</label>
                        <input type="text" id="newOutgoingInitiator" placeholder="e.g., GEC">
                    </div>
                    <div class="form-group">
                        <label for="newOutgoingAddressee">Addressee:</label>
                        <input type="text" id="newOutgoingAddressee" placeholder="e.g., Main Contractor">
                    </div>
                    <div class="form-group">
                        <label for="newOutgoingLetterRef">Outgoing Letter Ref.:</label>
                        <input type="text" id="newOutgoingLetterRef" placeholder="e.g., GEC-L-001" required>
                    </div>
                    <div class="form-group">
                        <label for="newOutgoingLetterDate">Letter Date:</label>
                        <input type="date" id="newOutgoingLetterDate">
                    </div>
                    <div class="form-group">
                        <label for="newOutgoingLetterSubject">Letter Subject:</label>
                        <textarea id="newOutgoingLetterSubject" rows="2" placeholder="Subject of the letter" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newOutgoingInReplyToRef">In Reply To Ref. (Optional):</label>
                        <input type="text" id="newOutgoingInReplyToRef" placeholder="e.g., MC-L-001">
                    </div>
                    <div class="form-group">
                        <label for="newOutgoingKeyword">Keyword:</label>
                        <select id="newOutgoingKeyword">
                            <option value="">--Select--</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newOutgoingReplyRequired">Reply Required?:</label>
                        <select id="newOutgoingReplyRequired" required>
                            <option value="">--Select--</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newOutgoingDateSent">Date Sent:</label>
                        <input type="date" id="newOutgoingDateSent">
                    </div>
                    <div class="form-group">
                        <label for="outgoingDocument">Upload Document:</label>
                        <input type="file" id="outgoingDocument">
                    </div>
                    <div class="form-group col-span-full flex justify-end space-x-2">
                        <button type="button" class="action-button" onclick="addNewOutgoingCorrespondence()">Add Outgoing</button>
                        <button type="button" class="secondary-button" onclick="clearNewOutgoingCorrespondenceForm()">Clear Form</button>
                    </div>
                </form>

                <div class="table-section mt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-700">All Outgoing Correspondences</h3>
                        <div class="flex space-x-2">
                            <button class="secondary-button" id="toggleOutgoingTableBtn" onclick="toggleTableVisibility('outgoingCorrespondenceTableContainer', 'toggleOutgoingTableBtn')">Hide Table</button>
                            <button class="action-button" onclick="downloadOutgoingCSV()">Download CSV</button>
                        </div>
                    </div>

                    <div class="flex flex-wrap items-end gap-4 mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="form-group m-0 flex-grow">
                            <label for="outgoingSearchInput" class="text-sm">Search All Fields:</label>
                            <input type="text" id="outgoingSearchInput" placeholder="Enter search term" class="w-full">
                        </div>
                        <div class="form-group m-0">
                            <label for="outgoingStatusFilter" class="text-sm">Filter by Status:</label>
                            <select id="outgoingStatusFilter" onchange="filterOutgoingByStatus(this.value)" class="w-full">
                                <option value="">All</option>
                                <option value="OPEN">OPEN</option>
                                <option value="CLOSED">CLOSED</option>
                            </select>
                        </div>
                        <div class="form-group m-0">
                            <label for="outgoingKeywordFilter" class="text-sm">Filter by Keyword:</label>
                            <select id="outgoingKeywordFilter" onchange="filterOutgoingByKeyword(this.value)" class="w-full">
                                <option value="">All Keywords</option>
                            </select>
                        </div>
                        <div class="flex space-x-2">
                            <button class="action-button" onclick="searchOutgoingCorrespondences()"><i class="fas fa-search"></i> Search</button>
                            <button class="secondary-button" onclick="clearOutgoingSearch()"><i class="fas fa-redo"></i> Reset</button>
                        </div>
                    </div>

                    <div id="outgoingCorrespondenceTableContainer" class="table-container">
                        <table id="outgoingCorrespondenceTable">
                            <thead>
                                <tr>
                                    <th>Initiator</th>
                                    <th>Addressee</th>
                                    <th>Letter Ref.</th>
                                    <th>Letter Date</th>
                                    <th>Letter Subject</th>
                                    <th>In Reply To Ref.</th>
                                    <th>Keyword</th>
                                    <th>Reply Required?</th>
                                    <th>Date Sent</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="incomingCorrespondenceSection" class="correspondence-section hidden">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Add/Edit Incoming Correspondence</h3>
                <form id="incomingCorrespondenceForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="newIncomingRef">Incoming Reference:</label>
                        <input type="text" id="newIncomingRef" placeholder="e.g., MC-L-001" required>
                    </div>
                    <div class="form-group">
                        <label for="newIncomingDateOfReceipt">Date of Receipt:</label>
                        <input type="date" id="newIncomingDateOfReceipt">
                    </div>
                    <div class="form-group">
                        <label for="newIncomingOriginator">Originator:</label>
                        <input type="text" id="newIncomingOriginator" placeholder="e.g., Main Contractor">
                    </div>
                    <div class="form-group">
                        <label for="newIncomingAddressee">Addressee:</label>
                        <input type="text" id="newIncomingAddressee" placeholder="e.g., GEC">
                    </div>
                    <div class="form-group">
                        <label for="newIncomingLetterSubject">Letter Subject:</label>
                        <textarea id="newIncomingLetterSubject" rows="2" placeholder="Subject of the letter" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newIncomingReplyToRef">Reply To Ref. (Optional):</label>
                        <input type="text" id="newIncomingReplyToRef" placeholder="e.g., GEC-L-001">
                    </div>
                    <div class="form-group">
                        <label for="newIncomingKeyword">Keyword:</label>
                        <select id="newIncomingKeyword">
                            <option value="">--Select--</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newIncomingReplyRequired">Reply Required?:</label>
                        <select id="newIncomingReplyRequired" required>
                            <option value="">--Select--</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="incomingDocument">Upload Document:</label>
                        <input type="file" id="incomingDocument">
                    </div>
                    <div class="form-group col-span-full flex justify-end space-x-2">
                        <button type="button" class="action-button" onclick="addNewIncomingCorrespondence()">Add Incoming</button>
                        <button type="button" class="secondary-button" onclick="clearNewIncomingCorrespondenceForm()">Clear Form</button>
                    </div>
                </form>

                <div class="table-section mt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-700">All Incoming Correspondences</h3>
                        <div class="flex space-x-2">
                            <button class="secondary-button" id="toggleIncomingTableBtn" onclick="toggleTableVisibility('incomingCorrespondenceTableContainer', 'toggleIncomingTableBtn')">Hide Table</button>
                            <button class="action-button" onclick="downloadIncomingCSV()">Download CSV</button>
                        </div>
                    </div>

                    <div class="flex flex-wrap items-end gap-4 mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="form-group m-0 flex-grow">
                            <label for="incomingSearchInput" class="text-sm">Search All Fields:</label>
                            <input type="text" id="incomingSearchInput" placeholder="Enter search term" class="w-full">
                        </div>
                        <div class="form-group m-0">
                            <label for="incomingStatusFilter" class="text-sm">Filter by Status:</label>
                            <select id="incomingStatusFilter" onchange="filterIncomingByStatus(this.value)" class="w-full">
                                <option value="">All</option>
                                <option value="OPEN">OPEN</option>
                                <option value="CLOSED">CLOSED</option>
                            </select>
                        </div>
                        <div class="form-group m-0">
                            <label for="incomingKeywordFilter" class="text-sm">Filter by Keyword:</label>
                            <select id="incomingKeywordFilter" onchange="filterIncomingByKeyword(this.value)" class="w-full">
                                <option value="">All Keywords</option>
                            </select>
                        </div>
                        <div class="flex space-x-2">
                            <button class="action-button" onclick="searchIncomingCorrespondences()"><i class="fas fa-search"></i> Search</button>
                            <button class="secondary-button" onclick="clearIncomingSearch()"><i class="fas fa-redo"></i> Reset</button>
                        </div>
                    </div>

                    <div id="incomingCorrespondenceTableContainer" class="table-container">
                        <table id="incomingCorrespondenceTable">
                            <thead>
                                <tr>
                                    <th>Incoming Ref.</th>
                                    <th>Date of Receipt</th>
                                    <th>Originator</th>
                                    <th>Addressee</th>
                                <th>Letter Subject</th>
                                    <th>Reply To Ref.</th>
                                    <th>Keyword</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="staffEmailsPage" class="page-content hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Staff Emails Management</h2>
            <div class="form-section">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Add/Edit Staff Email</h3>
                <form id="staffEmailForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="staffEmailName">Staff Name:</label>
                        <input type="text" id="staffEmailName" placeholder="e.g., John Doe" required>
                    </div>
                    <div class="form-group">
                        <label for="staffEmailAddress">Email Address:</label>
                        <input type="email" id="staffEmailAddress" placeholder="e.g., john.doe@company.com" required>
                    </div>
                    <div class="form-group col-span-full flex justify-end space-x-2">
                        <button type="button" id="addUpdateStaffButton" class="action-button" onclick="addUpdateStaffEmail()">Save Staff</button>
                        <button type="button" class="secondary-button" onclick="clearStaffForm()">Clear Form</button>
                    </div>
                </form>
            </div>
            
            <div class="table-section mt-8">
                <h3 class="text-xl font-semibold text-gray-700">All Staff Emails</h3>
                <div class="table-container">
                    <table id="staffEmailsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email Address</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

   <script type="module">
        // Import Supabase client
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.2/+esm';

        // --- Supabase Credentials ---
        const SUPABASE_URL = 'https://qhhwnetogqyciixxweog.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoaHduZXRvZ3F5Y2lpeHh3ZW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMjE1MjIsImV4cCI6MjA3MDg5NzUyMn0.rLt8q62CutMNUNIH__wAJB5RwaNXU8HDUT0vYMOQpQQ';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Global Variables ---
        let inspectionsData = [];
        let mirData = [];
        let ncrData = [];
        let submissionData = [];
        let outgoingCorrespondenceData = [];
        let incomingCorrespondenceData = [];
        let staffEmailsData = [];
        
        // Stores Supabase subscription handles
        const supabaseSubscriptions = {};
        
        let inspectionsEditingDocumentId = null;
        let mirEditingDocumentId = null;
        let ncrEditingDocumentId = null;
        let submissionCurrentlyEditingRowIndex = -1;
        let correspondenceCurrentlyEditingRowId = null;
        let correspondenceCurrentEditingTableType = '';
        let staffEditingEmailId = null;
        
        let submissionCurrentFilterStatus = '';
        let outgoingCurrentStatusFilter = '';
        let outgoingCurrentKeywordFilter = '';
        let incomingCurrentStatusFilter = '';
        let incomingCurrentKeywordFilter = '';
        
        let customConfirmResolve;
        let authMode = 'signIn';
        let userId = null;
        let welcomeMessageShown = false; // Add a flag to track if the welcome message has been shown

        let emailModalDocData = null;
        let emailModalDocType = '';

        // Mapping for discipline prefixes in document numbering
        const disciplinePrefixMap = {
            'Architectural': 'ARC', 'Civil': 'CIV', 'Structural': 'STR',
            'Electrical': 'ELE', 'Mechanical': 'MEC', 'Instrumentation': 'INS', 'Process': 'PRO',
            'Automation': 'AUT', 'Piping': 'PIP', 'Operations': 'OPE'
        };
        
        const submissionStatusOptions = [
            { value: "A", text: "A - Approved as Submitted" },
            { value: "B", text: "B - Approved with Comments" },
            { value: "C", text: "C - Revised and Resubmit" },
            { value: "D", text: "D - Returned" },
            { value: "UR", text: "UR - Under Review" },
            { value: "E", text: "E - For Information" },
            { value: "X", text: "X - Cancelled" }
        ];

        const submissionDocumentTypeOptions = ["MAR", "REP", "MST", "DOC", "DWG", "ASB", "ITP", "CAL", "PRQ"];
        
        const correspondenceKeywordOptions = [
            { value: "Audit", text: "Audit" },
            { value: "Civil", text: "Civil" },
            { value: "Closeout", text: "Closeout" },
            { value: "Commercial", text: "Commercial" },
            { value: "Commissioning", text: "Commissioning" },
            { value: "Damage", text: "Damage" },
            { value: "Delay Notice", text: "Delay Notice" },
            { value: "Design", text: "Design" },
            { value: "Dry Inspection", text: "Dry Inspection" },
            { value: "Electrical", text: "Electrical" },
            { value: "Environmental", text: "Environmental" },
            { value: "FAT", text: "FAT" },
            { value: "General", text: "General" },
            { value: "Handover", text: "Handover" },
            { value: "Handover Deliverables", text: "Handover Deliverables" },
            { value: "Health & Safety", text: "Health & Safety" },
            { value: "Joint Survey", text: "Joint Survey" },
            { value: "Kahramaa", text: "Kahramaa" },
            { value: "Material", text: "Material" },
            { value: "Mechanical", text: "Mechanical" },
            { value: "MOM", "text": "MOM" },
            { value: "NCR", text: "NCR" },
            { value: "O&M", text: "O&M" },
            { value: "Pattern Test", text: "Pattern Test" },
            { value: "PCC", "text": "PCC" },
            { value: "Performance Test", "text": "Performance Test" },
            { value: "Permit", text: "Permit" },
            { value: "Piping", text: "Piping" },
            { value: "Process", text: "Process" },
            { value: "Process Test", "text": "Process Test" },
            { value: "Procurement", text: "Procurement" },
            { value: "Programme Management", text: "Programme Management" },
            { value: "QA/QC", text: "QA/QC" },
            { value: "SAT", text: "SAT" },
            { value: "Site Acceptance", text: "Site Acceptance" },
            { value: "Site Facilities", text: "Site Facilities" },
            { value: "Site Instruction", text: "Site Instruction" },
            { value: "Snags", text: "Snags" },
            { value: "Spare Parts", text: "Spare Parts" },
            { value: "Staffing", text: "Staffing" },
            { value: "Submissions", text: "Submissions" },
            { value: "Training", text: "Training" },
            { value: "Trial Run", "text": "Trial Run" },
            { value: "Variation Order", text: "Variation Order" },
            { value: "Workmanship", text: "Workmanship" }
        ];

        const inspectionStatusOptions = [
            { value: "A", text: "A - Approved" },
            { value: "B", text: "B - Approved with Comments" },
            { value: "C", text: "C - Revised and Resubmit" },
            { value: "D", text: "D - Rejected" },
            { value: "UR", text: "UR - Under Review" },
            { value: "X", text: "X - Cancelled" }
        ];
        
        const mirApprovalStatusOptions = [
            { value: "A", text: "A - Approved" },
            { value: "B", text: "B - Approved with Comments" },
            { value: "C", text: "C - Rejected" },
            { value: "UR", text: "UR - Under Review" },
            { value: "X", text: "X - Cancelled" }
        ];

        const ncrStatuses = [
            { code: 'Open', description: 'Open' },
            { code: 'Closed', description: 'Closed' },
            { code: 'Under Review', description: 'Under Review' },
            { code: 'Pending Correction', description: 'Pending Correction' },
            { code: 'Check Latest Revision', description: 'Check Latest Revision' }
        ];


        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.tab-buttons button[onclick="showPage('${pageId}')"]`).classList.add('active');
        }

        function showLoadingOverlay(message = 'Loading...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingOverlay && loadingMessage) {
                loadingMessage.textContent = message;
                loadingOverlay.classList.remove('hidden');
            }
        }

        function hideLoadingOverlay() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
        }

        function populateFixedDropdowns() {
            function populateSelect(selectId, options) {
                const selectElement = document.getElementById(selectId);
                if (selectElement) {
                    let initialHtml = selectElement.querySelector('option[value=""]') ? '<option value="">--Select--</option>' : '';
                    selectElement.innerHTML = initialHtml;
                    options.forEach(option => {
                        const opt = document.createElement('option');
                        if (typeof option === 'object' && option !== null) {
                            opt.value = option.value;
                            opt.textContent = option.text;
                        } else {
                            opt.value = option;
                            opt.textContent = option;
                        }
                        selectElement.appendChild(opt);
                    });
                }
            }

            populateSelect('newDocType', submissionDocumentTypeOptions);
            populateSelect('newDiscipline', Object.keys(disciplinePrefixMap));
            populateSelect('outgoingKeywordFilter', correspondenceKeywordOptions);
            populateSelect('newOutgoingKeyword', correspondenceKeywordOptions);
            populateSelect('incomingKeywordFilter', correspondenceKeywordOptions);
            populateSelect('newIncomingKeyword', correspondenceKeywordOptions);
            populateSelect('documentStatus', inspectionStatusOptions);
            populateSelect('mirApprovalStatus', mirApprovalStatusOptions);
            populateSelect('ncrCurrentStatus', ncrStatuses.map(s => ({ value: s.code, text: s.description })));
            populateSelect('discipline', Object.keys(disciplinePrefixMap));
            populateSelect('mirDiscipline', Object.keys(disciplinePrefixMap));
            populateSelect('ncrDiscipline', Object.keys(disciplinePrefixMap));
        }

        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const messageElement = document.getElementById('customConfirmMessage');
                if (messageElement) messageElement.textContent = message;
                if (modal) modal.classList.remove('hidden');
                customConfirmResolve = resolve;
            });
        }

        function handleCustomConfirm(response) {
            document.getElementById('customConfirmModal').classList.add('hidden');
            if (customConfirmResolve) {
                customConfirmResolve(response);
                customConfirmResolve = null;
            }
        }

        function showMessageModal(message, title = 'Notification') {
            const modal = document.getElementById('messageModal');
            const titleElement = document.getElementById('messageModalTitle');
            const messageElement = document.getElementById('messageModalMessage');
            if (titleElement) titleElement.textContent = title;
            if (messageElement) messageElement.textContent = message;
            if (modal) modal.classList.remove('hidden');
        }

        function hideMessageModal() {
            const modal = document.getElementById('messageModal');
            if (modal) modal.classList.add('hidden');
        }

        function showForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').classList.remove('hidden');
            document.getElementById('resetEmail').value = document.getElementById('authEmail').value;
        }

        function hideForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').classList.add('hidden');
            document.getElementById('resetEmail').value = '';
        }
        
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        async function sendPasswordReset() {
            const email = document.getElementById('resetEmail').value;
            if (!email) {
                showMessageModal("Please enter your email address to reset your password.", "Missing Email");
                return;
            }
            if (!supabase) {
                showMessageModal("Supabase is not ready. Please wait a moment and try again.", "Initialization Error");
                return;
            }

            showLoadingOverlay('Sending password reset email...');
            try {
                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin
                });
                if (error) throw error;
                hideForgotPasswordModal();
                showMessageModal("A password reset link has been sent to your email address.", "Password Reset Sent");
            } catch (error) {
                console.error("Password reset error:", error);
                let errorMessage = "Failed to send password reset email.";
                if (error.code === 400) {
                    errorMessage = "Invalid email address or user not found.";
                } else {
                    errorMessage += " " + error.message;
                }
                showMessageModal(errorMessage, "Password Reset Failed");
            } finally {
                hideLoadingOverlay();
            }
        }

        function showEmailModal(docData, docType) {
            emailModalDocData = docData;
            emailModalDocType = docType;

            let docId = docData.id;
            let docDetails;

            // Retrieve the correct document data based on the type and ID
            switch(docType) {
                case 'inspections':
                    docDetails = inspectionsData.find(d => d.id === docId);
                    if (docDetails) {
                        document.getElementById('emailModalTitle').textContent = `Email: ${docDetails.work_to_be_inspected}`;
                    }
                    break;
                case 'mir':
                    docDetails = mirData.find(d => d.id === docId);
                    if (docDetails) {
                        document.getElementById('emailModalTitle').textContent = `Email: ${docDetails.description_material}`;
                    }
                    break;
                case 'ncr':
                    docDetails = ncrData.find(d => d.id === docId);
                    if (docDetails) {
                        document.getElementById('emailModalTitle').textContent = `Email: ${docDetails.ncr_description}`;
                    }
                    break;
                case 'submissions':
                    docDetails = submissionData.find(d => d.id === docId);
                    if (docDetails) {
                        document.getElementById('emailModalTitle').textContent = `Email: ${docDetails.doc_title}`;
                    }
                    break;
                case 'outgoing_correspondences':
                    docDetails = outgoingCorrespondenceData.find(d => d.id === docId);
                    if (docDetails) {
                        document.getElementById('emailModalTitle').textContent = `Email: ${docDetails.letter_subject}`;
                    }
                    break;
                case 'incoming_correspondences':
                    docDetails = incomingCorrespondenceData.find(d => d.id === docId);
                    if (docDetails) {
                        document.getElementById('emailModalTitle').textContent = `Email: ${docDetails.letter_subject}`;
                    }
                    break;
            }

            emailModalDocData = docDetails;
            
            const checkboxesContainer = document.getElementById('staffEmailCheckboxes');
            checkboxesContainer.innerHTML = '';
            if (staffEmailsData.length === 0) {
                checkboxesContainer.innerHTML = '<p class="text-sm text-gray-500">No staff emails saved. Please add some in the "Staff Emails" tab.</p>';
                document.getElementById('sendEmailButton').disabled = true;
            } else {
                staffEmailsData.forEach(staff => {
                    const label = document.createElement('label');
                    label.innerHTML = `
                        <input type="checkbox" value="${staff.email}" class="form-checkbox h-4 w-4 text-blue-600">
                        <span class="ml-2 text-gray-700">${staff.name} (${staff.email})</span>
                    `;
                    checkboxesContainer.appendChild(label);
                });
                document.getElementById('sendEmailButton').disabled = false;
            }

            document.getElementById('emailModal').classList.remove('hidden');
        }

        function hideEmailModal() {
            document.getElementById('emailModal').classList.add('hidden');
            emailModalDocData = null;
            emailModalDocType = '';
        }

        function sendEmailViaOutlook() {
            const selectedEmails = Array.from(document.querySelectorAll('#staffEmailCheckboxes input[type="checkbox"]:checked')).map(cb => cb.value);
            if (selectedEmails.length === 0) {
                showMessageModal("Please select at least one recipient.", "Missing Recipient");
                return;
            }

            let subject = "Document Details";
            let body = "Please find the details of the document:\n\n";
            let docInfo = "Document";
            let docUrl = "";

            if (emailModalDocData) {
                if (emailModalDocType === 'inspections') {
                    subject = `Details: Inspection ${emailModalDocData.ins_number}`;
                    docInfo = `Inspection: ${emailModalDocData.ins_number} - ${emailModalDocData.work_to_be_inspected}\n\n`;
                    docUrl = emailModalDocData.inspections_document_url;
                } else if (emailModalDocType === 'mir') {
                    subject = `Details: MIR ${emailModalDocData.mir_number}`;
                    docInfo = `Material Inspection Request: ${emailModalDocData.mir_number} - ${emailModalDocData.description_material}\n\n`;
                    docUrl = emailModalDocData.mir_document_url;
                } else if (emailModalDocType === 'ncr') {
                    subject = `Details: NCR ${emailModalDocData.ncr_ref_number}`;
                    docInfo = `Non-Conformance Report: ${emailModalDocData.ncr_ref_number} - ${emailModalDocData.ncr_description}\n\n`;
                    docUrl = emailModalDocData.ncr_document_url;
                } else if (emailModalDocType === 'submissions') {
                    subject = `Details: Submission ${emailModalDocData.doc_number} - ${emailModalDocData.doc_title}`;
                    docInfo = `Submission Document: ${emailModalDocData.doc_number}\n\n`;
                    docUrl = emailModalDocData.document_url;
                } else if (emailModalDocType === 'outgoing_correspondences') {
                    subject = `Details: Outgoing Correspondence ${emailModalDocData.letter_ref}`;
                    docInfo = `Outgoing Correspondence: ${emailModalDocData.letter_ref}\n\n`;
                    docUrl = emailModalDocData.outgoing_document_url;
                } else if (emailModalDocType === 'incoming_correspondences') {
                    subject = `Details: Incoming Correspondence ${emailModalDocData.incoming_ref}`;
                    docInfo = `Incoming Correspondence: ${emailModalDocData.incoming_ref}\n\n`;
                    docUrl = emailModalDocData.incoming_document_url;
                }
                
                for (const key in emailModalDocData) {
                    if (key !== 'id' && key !== 'user_id' && !key.includes('document_url')) {
                        let value = emailModalDocData[key];
                        if (key.toLowerCase().includes('date')) {
                            value = formatDateForDisplay(value);
                        }
                        docInfo += `${key.replace(/_/g, ' ').charAt(0).toUpperCase() + key.replace(/_/g, ' ').slice(1)}: ${value}\n`;
                    }
                }
            }

            if (docUrl) {
                body += `Document Link: ${docUrl}\n\n`;
            }
            
            body += `${docInfo}\n\nBest regards,\nSMARTRACK`;
            
            const mailtoLink = `mailto:${selectedEmails.join(';')}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink, '_blank');

            hideEmailModal();
        }

        function toggleTableVisibility(tableContainerId, buttonId) {
            const tableContainer = document.getElementById(tableContainerId);
            const button = document.getElementById(buttonId);
            if (tableContainer.classList.contains('hidden')) {
                tableContainer.classList.remove('hidden');
                button.textContent = 'Hide Table';
            } else {
                tableContainer.classList.add('hidden');
                button.textContent = 'Show Table';
            }
        }

        function showCorrespondenceSection(sectionId) {
            document.querySelectorAll('.correspondence-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            document.querySelectorAll('#correspondencePage .tab-buttons .tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`#correspondencePage .tab-buttons button[onclick="showCorrespondenceSection('${sectionId}')"]`).classList.add('active');
        }

        function disableSupabaseUI() {
            const appContentElements = document.querySelectorAll('#appContainer input, #appContainer select, #appContainer textarea, #appContainer button, #appContainer .tab-button');
            appContentElements.forEach(element => {
                element.style.opacity = '0.5';
                element.style.pointerEvents = 'none';
            });
        }

        function enableSupabaseUI() {
            const appContentElements = document.querySelectorAll('#appContainer input, #appContainer select, #appContainer textarea, #appContainer button, #appContainer .tab-button');
            appContentElements.forEach(element => {
                element.style.pointerEvents = 'auto';
                element.style.opacity = '1';
            });
        }

        function toggleAppUI(isAuthenticated) {
            const authContainer = document.getElementById('authContainer');
            const appContainer = document.getElementById('appContainer');

            if (isAuthenticated) {
                if (authContainer) authContainer.classList.add('hidden');
                if (appContainer) appContainer.classList.remove('hidden');
                enableSupabaseUI();
            } else {
                if (authContainer) authContainer.classList.remove('hidden');
                if (appContainer) appContainer.classList.add('hidden');
                disableSupabaseUI();
            }
        }

        function toggleAuthMode() {
            const authTitle = document.getElementById('authTitle');
            const authSubmitButton = document.getElementById('authSubmitButton');
            const toggleAuthMessage = document.querySelector('.toggle-mode-link');

            if (authMode === 'signIn') {
                authMode = 'signUp';
                authTitle.textContent = 'Sign Up';
                authSubmitButton.textContent = 'Sign Up';
                toggleAuthMessage.innerHTML = 'Already have an account? <button onclick="toggleAuthMode()" class="text-blue-600 hover:underline">Sign In</button>';
            } else {
                authMode = 'signIn';
                authTitle.textContent = 'Sign In';
                authSubmitButton.textContent = 'Sign In';
                toggleAuthMessage.innerHTML = "Don't have an account? <button onclick=\"toggleAuthMode()\" class=\"text-blue-600 hover:underline\">Sign Up</button>";
            }
        }

        async function handleAuthSubmit() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;

            if (!supabase) {
                showMessageModal("Supabase is not ready. Please wait a moment and try again.", "Initialization Error");
                return;
            }

            if (!email || !password) {
                showMessageModal("Please enter both email and password.", "Missing Credentials");
                return;
            }

            if (authMode === 'signUp') {
                await handleSignUp(email, password);
            } else {
                await handleSignIn(email, password);
            }
        }

        async function handleSignUp(email, password) {
            showLoadingOverlay('Signing up...');
            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password
                });
                if (error) throw error;
                showMessageModal("Account created successfully! Please check your email for a verification link.", "Success");
            } catch (error) {
                console.error("Sign Up Error:", error);
                let errorMessage = "Failed to create account.";
                if (error.message.includes('already registered')) {
                    errorMessage = "This email is already in use. Please sign in or use a different email.";
                } else if (error.message.includes('weak password')) {
                    errorMessage = "Password is too weak. Please choose a stronger password (at least 6 characters).";
                }
                showMessageModal(errorMessage, "Sign Up Failed");
            } finally {
                hideLoadingOverlay();
            }
        }

        async function handleSignIn(email, password) {
            showLoadingOverlay('Signing in...');
            try {
                const { error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                if (error) throw error;
                showMessageModal("Signed in successfully!", "Success");
            } catch (error) {
                console.error("Sign In Error:", error);
                let errorMessage = "Failed to sign in.";
                if (error.message.includes('invalid credentials')) {
                    errorMessage = "Invalid email or password.";
                }
                showMessageModal(errorMessage, "Sign In Failed");
            } finally {
                hideLoadingOverlay();
            }
        }

        async function handleSignOut() {
            showLoadingOverlay('Signing out...');
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                document.getElementById('authEmail').value = '';
                document.getElementById('authPassword').value = '';
                welcomeMessageShown = false; // Reset the flag on sign out
                showMessageModal("Signed out successfully. You can sign in again.", "Signed Out");
            } catch (error) {
                console.error("Sign Out Error:", error);
                showMessageModal("Failed to sign out: " + error.message, "Error");
            } finally {
                hideLoadingOverlay();
            }
        }

        async function initializeSupabase() {
            console.log("Starting Supabase initialization...");

            const displayUserIdSpan = document.getElementById('displayUserId');
            const appIdStatusSpan = document.getElementById('appIdStatus');
            const firebaseConfigStatusSpan = document.getElementById('firebaseConfigStatus');
            
            if (displayUserIdSpan) displayUserIdSpan.textContent = 'Authenticating...';
            if (appIdStatusSpan) appIdStatusSpan.textContent = 'Checking...';
            if (firebaseConfigStatusSpan) firebaseConfigStatusSpan.textContent = 'Checking...';

            // Check if Supabase client is initialized
            if (supabase) {
                if (firebaseConfigStatusSpan) {
                    firebaseConfigStatusSpan.textContent = `Supabase (Initialized OK)`;
                    firebaseConfigStatusSpan.classList.add('ok');
                    firebaseConfigStatusSpan.classList.remove('error');
                }
            } else {
                if (firebaseConfigStatusSpan) {
                    firebaseConfigStatusSpan.textContent = 'Initialization Failed';
                    firebaseConfigStatusSpan.classList.add('error');
                    firebaseConfigStatusSpan.classList.remove('ok');
                }
                showMessageModal(
                    'A critical error occurred while initializing Supabase. Please check the console for details ' +
                    'and ensure your Supabase setup is correct. Data persistence will not work.',
                    'Critical Error'
                );
                disableSupabaseUI();
                hideLoadingOverlay();
                return;
            }

            // Listen for auth state changes
            supabase.auth.onAuthStateChange((event, session) => {
                if (session) {
                    userId = session.user.id;
                    console.log(`[Auth State] User signed in with UID: ${userId}`);
                    if (displayUserIdSpan) displayUserIdSpan.textContent = userId;
                    toggleAppUI(true);
                    loadAllDataListeners();
                    // Only show the welcome message on the initial sign-in event
                    if (event === 'SIGNED_IN' && !welcomeMessageShown) {
                        showMessageModal("Welcome! Your data is being loaded.", "Welcome Back!");
                        welcomeMessageShown = true;
                    }
                } else {
                    console.log("[Auth State] No user found or signed out. Displaying authentication options.");
                    userId = null;
                    toggleAppUI(false);
                    welcomeMessageShown = false; // Reset the flag
                    if (displayUserIdSpan) displayUserIdSpan.textContent = 'Not Authenticated';
                    detachAllSupabaseListeners();
                }
                hideLoadingOverlay();
            });
        }

        function detachAllSupabaseListeners() {
            for (const table in supabaseSubscriptions) {
                if (supabaseSubscriptions[table]) {
                    supabaseSubscriptions[table].unsubscribe();
                    console.log(`[Supabase] Detached listener for ${table}`);
                }
            }
            inspectionsData = [];
            mirData = [];
            ncrData = [];
            submissionData = [];
            outgoingCorrespondenceData = [];
            incomingCorrespondenceData = [];
            staffEmailsData = [];
            performInspectionsSearch();
            performMirSearch();
            performNcrSearch();
            searchSubmissionDocuments();
            searchOutgoingCorrespondences();
            searchIncomingCorrespondences();
            renderStaffEmails();
        }

        async function subscribeToTable(tableName) {
            console.log(`[Supabase] Setting up real-time listener for: ${tableName}`);
            const channel = supabase.channel(`public_channel_${tableName}`);
            
            channel.on('postgres_changes', { event: '*', schema: 'public', table: tableName }, async (payload) => {
                console.log(`[Supabase Realtime] Change detected in ${tableName}:`, payload);
                await fetchAndRenderData(tableName);
            })
            .subscribe();

            supabaseSubscriptions[tableName] = channel;
        }

        async function fetchAndRenderData(tableName) {
            const { data, error } = await supabase.from(tableName).select('*').eq('user_id', userId);
            if (error) {
                console.error(`[Supabase Error] Error fetching data for ${tableName}:`, error);
                return;
            }
            switch (tableName) {
                case 'inspections':
                    inspectionsData = data;
                    performInspectionsSearch();
                    break;
                case 'mir':
                    mirData = data;
                    performMirSearch();
                    break;
                case 'ncr':
                    ncrData = data;
                    performNcrSearch();
                    break;
                case 'submissions':
                    submissionData = data;
                    searchSubmissionDocuments();
                    break;
                case 'outgoing_correspondences':
                    outgoingCorrespondenceData = data;
                    searchOutgoingCorrespondences();
                    break;
                case 'incoming_correspondences':
                    incomingCorrespondenceData = data;
                    searchIncomingCorrespondences();
                    break;
                case 'staff_emails':
                    staffEmailsData = data;
                    renderStaffEmails();
                    break;
            }
            console.log(`[Supabase] Fetched ${data.length} documents for ${tableName}`);
        }

        async function loadAllDataListeners() {
            console.log("Loading all data listeners...");
            if (!userId) {
                console.warn("User not authenticated. Cannot load data listeners.");
                return;
            }
            subscribeToTable('inspections');
            subscribeToTable('mir');
            subscribeToTable('ncr');
            subscribeToTable('submissions');
            subscribeToTable('outgoing_correspondences');
            subscribeToTable('incoming_correspondences');
            subscribeToTable('staff_emails');
            
            await fetchAndRenderData('inspections');
            await fetchAndRenderData('mir');
            await fetchAndRenderData('ncr');
            await fetchAndRenderData('submissions');
            await fetchAndRenderData('outgoing_correspondences');
            await fetchAndRenderData('incoming_correspondences');
            await fetchAndRenderData('staff_emails');

            updateNextInsNumber();
            updateNextMirNumber();
        }

        function compareRevisions(rev1, rev2) {
            if (!rev1 && !rev2) return 0;
            if (!rev1) return -1;
            if (!rev2) return 1;

            if (rev1 === rev2) return 0;
            const num1 = parseInt(rev1, 10);
            const num2 = parseInt(rev2, 10);

            if (!isNaN(num1) && !isNaN(num2) && String(num1) === rev1 && String(num2) === rev2) {
                if (num1 !== num2) return num1 - num2;
            }

            return rev1.localeCompare(rev2, undefined, { numeric: true, sensitivity: 'base' });
        }

        function getNextRevision(currentRev) {
            if (!currentRev) {
                return '0';
            }

            const numRev = parseInt(currentRev, 10);
            if (!isNaN(numRev) && String(numRev) === currentRev) {
                return String(numRev + 1);
            }

            const lastChar = currentRev.slice(-1);
            const prefix = currentRev.slice(0, -1);

            if (lastChar.match(/[A-Z]/i)) {
                const charCode = lastChar.toUpperCase().charCodeAt(0);
                if (charCode === 90) {
                    if (prefix) {
                        return getNextRevision(prefix) + 'A';
                    } else {
                        return 'AA';
                    }
                } else {
                    return prefix + String.fromCharCode(charCode + 1);
                }
            }

            const mixedMatch = currentRev.match(/^(\d+)([A-Z]+)$/i);
            if (mixedMatch) {
                const numPart = mixedMatch[1];
                const alphaPart = mixedMatch[2];
                const lastAlphaChar = alphaPart.slice(-1);
                const alphaPrefix = alphaPart.slice(0, -1);
                const charCode = lastAlphaChar.toUpperCase().charCodeAt(0);
                if (charCode === 90) {
                    return numPart + getNextRevision(alphaPart);
                } else {
                    return numPart + alphaPrefix + String.fromCharCode(charCode + 1);
                }
            }

            return currentRev + '-next';
        }


        async function generateNextDocNumber(tableName, prefix, numberField, discipline = '') {
            if (!supabase || !userId) {
                console.warn("Supabase or User ID not ready for generating next doc number. Returning fallback message.");
                return 'Loading...';
            }

            let maxNumber = 0;

            try {
                const { data, error } = await supabase
                    .from(tableName)
                    .select(numberField)
                    .eq('user_id', userId);
                if (error) throw error;
                
                data.forEach(item => {
                    const value = item[numberField];
                    if (value) {
                        const parts = String(value).split('-');
                        if (parts.length > 0) {
                            const lastPart = parts[parts.length - 1];
                            const num = parseInt(lastPart, 10);
                            if (!isNaN(num) && num > maxNumber) {
                                maxNumber = num;
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error fetching documents for next number generation:", error);
                return 'Error';
            }

            const nextNumber = maxNumber + 1;
            const formattedNumber = String(nextNumber).padStart(4, '0');
            if (discipline && disciplinePrefixMap[discipline]) {
                return `${prefix}-${disciplinePrefixMap[discipline]}-${formattedNumber}`;
            }
            if (prefix.includes('-')) {
                return `${prefix.substring(0, prefix.lastIndexOf('-')+1)}${formattedNumber}`;
            }
            return `${prefix}-${formattedNumber}`;
        }


        function calculateDaysOverdue(submitted_date, responded_date) {
            if (!submitted_date) return '';
            const subDate = new Date(submitted_date);
            const dueDate = new Date(subDate);
            dueDate.setDate(subDate.getDate() + 14);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let actualResponseDate = responded_date ? new Date(responded_date) : today;
            actualResponseDate.setHours(0, 0, 0, 0);
            if (actualResponseDate > dueDate) {
                const diffTime = Math.abs(actualResponseDate.getTime() - dueDate.getTime());
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            }
            return 0;
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) {
                return '';
            }

            let date;
            if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                date = new Date(dateString + 'T00:00:00');
            } else if (dateString.match(/^\d{2}-\d{2}-\d{4}$/)) {
                const parts = dateString.split('-');
                date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
            } else if (dateString.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                date = new Date(dateString);
            } else {
                date = new Date(dateString);
            }

            if (isNaN(date.getTime())) {
                console.warn("Invalid date string encountered in formatDateForDisplay:", dateString);
                return '';
            }

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${month}/${day}/${year}`;
        }

        function formatDateForInput(dateString) {
            if (!dateString) {
                return '';
            }

            let date;
            if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                date = new Date(dateString + 'T00:00:00');
            } else if (dateString.match(/^\d{2}-\d{2}-\d{4}$/)) {
                const parts = dateString.split('-');
                date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
            } else if (dateString.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                date = new Date(dateString);
            } else {
                date = new Date(dateString);
            }

            if (isNaN(date.getTime())) {
                console.warn("Invalid date string encountered in formatDateForInput:", dateString);
                return '';
            }

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${year}-${month}-${day}`;
        }

        function getApprovalSummaryText(statusCode) {
            const statusMap = {
                "A": "Approved",
                "B": "Approved with Comments",
                "C": "Revised & Resubmit",
                "D": "Returned",
                "UR": "Under Review",
                "E": "For Information",
                "X": "Cancelled",
                "Hold": "Hold"
            };
            return statusMap[statusCode] || statusCode || '';
        }

        async function uploadFileToSupabase(file, bucketName, filePath) {
            if (!supabase || !userId) {
                console.error("Supabase or User ID not ready. File upload failed.");
                return { success: false, url: null };
            }
            try {
                const { data, error } = await supabase.storage.from(bucketName).upload(filePath, file);
                if (error) throw error;
                
                const { data: publicUrlData } = supabase.storage.from(bucketName).getPublicUrl(filePath);
                
                return { success: true, url: publicUrlData.publicUrl };
            } catch (error) {
                console.error("Error uploading file:", error);
                showMessageModal("Error uploading file: " + error.message, "File Upload Failed");
                return { success: false, url: null };
            }
        }

        async function saveDocument(tableName, docId, data) {
            if (!supabase || !userId) {
                console.error(`[Supabase Check] Supabase not ready for saving document to ${tableName}.`);
                showMessageModal("Data persistence is not available. Please ensure Supabase is correctly configured and authenticated.", "Error Saving Data");
                return { success: false, error: new Error("Supabase or User ID not ready.") };
            }
            showLoadingOverlay('Saving document...');
            data.user_id = userId;
            console.log(`[Supabase] Attempting to save document to table: ${tableName} with ID: ${docId}`);
            try {
                const { error } = await supabase.from(tableName).update(data).eq('id', docId);
                if (error) throw error;
                console.log(`[Supabase] Document saved successfully to ${tableName} with ID: ${docId}`);
                return { success: true, id: docId };
            } catch (e) {
                console.error(`[Supabase Error] Error adding/updating document in ${tableName} with ID ${docId}: `, e);
                showMessageModal("Error saving document: " + e.message, "Error");
                return { success: false, error: e };
            } finally {
                hideLoadingOverlay();
            }
        }

        async function addDocument(tableName, data) {
            if (!supabase || !userId) {
                console.error(`[Supabase Check] Supabase not ready for adding document to ${tableName}.`);
                showMessageModal("Data persistence is not available. Please ensure Supabase is correctly configured and authenticated.", "Error Adding Data");
                return { success: false, error: new Error("Supabase or User ID not ready.") };
            }
            showLoadingOverlay('Adding new document...');
            data.user_id = userId;
            console.log(`[Supabase] Attempting to add document to table: ${tableName}`);

            try {
                const { data: newDoc, error } = await supabase.from(tableName).insert([data]).select();
                if (error) throw error;
                const newDocId = newDoc[0].id;
                console.log(`[Supabase] New document added to ${tableName} with ID: ${newDocId}`);
                return { success: true, id: newDocId };
            } catch (e) {
                console.error(`[Supabase Error] Error adding new document to ${tableName}: `, e);
                showMessageModal("Error adding document: " + e.message, "Error");
                return { success: false, error: e };
            } finally {
                hideLoadingOverlay();
            }
        }

        async function deleteDocument(tableName, docId) {
            const confirmDelete = await showCustomConfirm('Are you sure you want to delete this document? This action cannot be undone.');
            if (!confirmDelete) {
                showMessageModal("Document deletion cancelled.", "Cancelled");
                return { success: false, error: new Error("User cancelled deletion.") };
            }

            if (!supabase || !userId) {
                console.error(`[Supabase Check] Supabase not ready for deleting document from ${tableName}.`);
                showMessageModal("Data persistence is not available. Please ensure Supabase is correctly configured and authenticated.", "Error Deleting Data");
                return { success: false, error: new Error("Supabase or User ID not ready.") };
            }
            showLoadingOverlay('Deleting document...');
            try {
                console.log(`[Supabase] Attempting to delete document from table: ${tableName} with ID: ${docId}`);
                const { error } = await supabase.from(tableName).delete().eq('id', docId);
                if (error) throw error;
                console.log(`[Supabase] Document deleted from ${tableName} with ID: ${docId}`);
                showMessageModal("Document deleted successfully!", "Success");
                return { success: true };
            } catch (e) {
                console.error(`[Supabase Error] Error deleting document: `, e);
                showMessageModal("Error deleting document: " + e.message, "Error");
                return { success: false, error: e };
            } finally {
                hideLoadingOverlay();
            }
        }

        // --- Specific Register Functions (Add/Update/Edit/Clear) ---

        async function addUpdateInspectionDocument() {
            if (!userId) {
                showMessageModal("You must be signed in to add a document.", "Authentication Required");
                return;
            }

            console.log("[Inspections] Starting addUpdateInspectionDocument...");
            const form = document.getElementById('inspectionForm');
            const docId = form.dataset.docId;
            const fileInput = document.getElementById('inspectionDocument');
            const file = fileInput.files[0];
            let fileUrl = '';
            
            const commentReceivedDateValue = document.getElementById('commentReceivedDate').value;
            const inspectionDateValue = document.getElementById('inspectionDate').value;
            const inspectionTimeValue = document.getElementById('inspectionTime').value;

            const data = {
                date: document.getElementById('date').value,
                ins_number: document.getElementById('insNumber').value,
                revision: document.getElementById('revision').value,
                discipline: document.getElementById('discipline').value,
                location: document.getElementById('location').value,
                work_to_be_inspected: document.getElementById('workToBeInspected').value,
                inspection_date: inspectionDateValue ? inspectionDateValue : null,
                inspection_time: inspectionTimeValue ? inspectionTimeValue : null,
                approved_drawing_ref: document.getElementById('approvedDrawingRef').value,
                specification_ref: document.getElementById('specificationRef').value,
                approved_method_statement_ref: document.getElementById('approvedMethodStatementRef').value,
                qcs_reference: document.getElementById('qcsReference').value,
                comment_received_date: commentReceivedDateValue ? commentReceivedDateValue : null,
                document_status: document.getElementById('documentStatus').value,
                rev_status: '',
                approval_summary_status: getApprovalSummaryText(document.getElementById('documentStatus').value),
                user_id: userId
            };
            if (!data.date || !data.ins_number || !data.revision || !data.discipline || !data.document_status) {
                showMessageModal("Please fill in all required fields: Date, INS Number, Revision, Discipline, and Document Status.", "Missing Information");
                console.warn("[Inspections] Required fields missing. Operation aborted.");
                return;
            }

            if (file) {
                showLoadingOverlay('Uploading file...');
                const filePath = `${userId}/inspections/${Date.now()}-${file.name}`;
                const uploadResult = await uploadFileToSupabase(file, 'documents', filePath);
                if (!uploadResult.success) {
                    return;
                }
                fileUrl = uploadResult.url;
                data.inspections_document_url = fileUrl;
            }

            try {
                let result;
                if (docId) {
                    console.log(`[Inspections] Updating existing document with ID: ${docId}`, data);
                    const currentDoc = inspectionsData.find(d => d.id === docId);
                    if (currentDoc) {
                        data.rev_status = currentDoc.rev_status;
                    }
                    result = await saveDocument('inspections', docId, data);
                } else {
                    console.log("[Inspections] Adding new document or new revision:", data);
                    const existingLatestInspections = inspectionsData.filter(d =>
                        d.ins_number === data.ins_number &&
                        d.discipline === data.discipline &&
                        d.rev_status === 'Latest'
                    );
                    let previousLatestDoc = null;
                    if (existingLatestInspections.length > 0) {
                        existingLatestInspections.sort((a, b) => compareRevisions(a.revision, b.revision));
                        previousLatestDoc = existingLatestInspections[existingLatestInspections.length - 1];
                    }

                    if (previousLatestDoc && compareRevisions(data.revision, previousLatestDoc.revision) > 0) {
                        console.log(`[Inspections] Marking previous latest inspection (${previousLatestDoc.id}) as Superseded.`);
                        await saveDocument('inspections', previousLatestDoc.id, { rev_status: 'Superseded' });
                    } else if (previousLatestDoc && compareRevisions(data.revision, previousLatestDoc.revision) < 0) {
                        showMessageModal("The revision you are adding is older than an existing 'Latest' revision for this INS Number and Discipline. Please check the revision number.", "Warning: Older Revision");
                        data.rev_status = 'Superseded';
                    }

                    data.rev_status = 'Latest';
                    result = await addDocument('inspections', data);
                }

                if (result.success) {
                    showMessageModal("Inspection document saved successfully!", "Success");
                    clearInspectionsForm();
                    await fetchAndRenderData('inspections'); // Manually trigger re-render
                } else {
                    console.error("[Inspections] Document operation failed:", result.error);
                }
            } catch (e) {
                console.error("[Inspections] Unhandled error during document operation:", e);
                showMessageModal("An unexpected error occurred during inspection document operation: " + e.message, "Operation Error");
            }
        }

        function clearInspectionsForm() {
            document.getElementById('inspectionForm').reset();
            document.getElementById('inspectionForm').removeAttribute('data-doc-id');
            document.getElementById('addUpdateButton').textContent = 'Add Document';
            document.getElementById('revStatus').value = '';
            updateNextInsNumber();
            console.log("[Inspections] Form cleared.");
        }

        async function editInspection(docId) {
            showLoadingOverlay('Loading inspection data...');
            if (!supabase || !userId) {
                showMessageModal("Application not fully loaded or Supabase not connected. Please wait and try again.", "Error");
                hideLoadingOverlay();
                return;
            }
            try {
                const { data, error } = await supabase
                    .from('inspections')
                    .select('*')
                    .eq('id', docId)
                    .single();
                if (error) throw error;
                if (data) {
                    document.getElementById('date').value = formatDateForInput(data.date) || '';
                    document.getElementById('insNumber').value = data.ins_number || '';
                    document.getElementById('revision').value = data.revision || '';
                    document.getElementById('discipline').value = data.discipline || '';
                    document.getElementById('location').value = data.location || '';
                    document.getElementById('workToBeInspected').value = data.work_to_be_inspected || '';
                    document.getElementById('inspectionDate').value = formatDateForInput(data.inspection_date) || '';
                    document.getElementById('inspectionTime').value = data.inspection_time || '';
                    document.getElementById('approvedDrawingRef').value = data.approved_drawing_ref || '';
                    document.getElementById('specificationRef').value = data.specification_ref || '';
                    document.getElementById('approvedMethodStatementRef').value = data.approved_method_statement_ref || '';
                    document.getElementById('qcsReference').value = data.qcs_reference || '';
                    document.getElementById('commentReceivedDate').value = formatDateForInput(data.comment_received_date) || '';
                    document.getElementById('documentStatus').value = data.document_status || '';
                    document.getElementById('revStatus').value = data.rev_status || '';

                    document.getElementById('inspectionForm').dataset.docId = docId;
                    document.getElementById('addUpdateButton').textContent = 'Update Document';
                    window.scrollTo(0, 0);
                    console.log(`[Inspections] Data for ${docId} loaded into form for editing.`);
                } else {
                    console.error("No such inspection document!");
                    showMessageModal("Document not found for editing.", "Error");
                }
            } catch (error) {
                console.error("Error fetching inspection document for edit:", error);
                showMessageModal("Error loading document for editing: " + error.message, "Error");
            } finally {
                hideLoadingOverlay();
            }
        }

        // MIR Register
        async function addUpdateMirDocument() {
            if (!userId) {
                showMessageModal("You must be signed in to add a document.", "Authentication Required");
                return;
            }

            console.log("[MIR] Starting addUpdateMirDocument...");
            const form = document.getElementById('mirForm');
            const docId = form.dataset.docId;
            const fileInput = document.getElementById('mirDocument');
            const file = fileInput.files[0];
            let fileUrl = '';
            
            const dateMaterialReceivedValue = document.getElementById('dateMaterialReceived').value;
            const mirInspectionDateValue = document.getElementById('mirInspectionDate').value;
            const mirInspectionTimeValue = document.getElementById('mirInspectionTime').value;
            const mirSubmissionDateValue = document.getElementById('mirSubmissionDate').value;
            const mirResponseDateValue = document.getElementById('mirResponseDate').value;

            const data = {
                mir_date: document.getElementById('mirDate').value,
                mir_number: document.getElementById('mirNumber').value,
                mir_revision: document.getElementById('mirRevision').value,
                mir_discipline: document.getElementById('mirDiscipline').value,
                date_material_received: dateMaterialReceivedValue ? dateMaterialReceivedValue : null,
                mir_inspection_date: mirInspectionDateValue ? mirInspectionDateValue : null,
                mir_inspection_time: mirInspectionTimeValue ? mirInspectionTimeValue : null,
                material_approval_ref: document.getElementById('materialApprovalRef').value,
                description_material: document.getElementById('descriptionMaterial').value,
                delivery_note_number: document.getElementById('deliveryNoteNumber').value,
                manufacturer: document.getElementById('manufacturer').value,
                supplier: document.getElementById('supplier').value,
                country_origin: document.getElementById('countryOrigin').value,
                mir_submission_date: mirSubmissionDateValue ? mirSubmissionDateValue : null,
                mir_response_date: mirResponseDateValue ? mirResponseDateValue : null,
                mir_approval_status: document.getElementById('mirApprovalStatus').value,
                mir_rev_status: '',
                mir_approval_summary_status: getApprovalSummaryText(document.getElementById('mirApprovalStatus').value),
                user_id: userId
            };
            if (!data.mir_date || !data.mir_number || !data.mir_revision || !data.mir_discipline || !data.mir_approval_status) {
                showMessageModal("Please fill in all required fields: Date, MIR Number, Revision, Discipline, and Approval Status.", "Missing Information");
                console.warn("[MIR] Required fields missing. Operation aborted.");
                return;
            }

            if (file) {
                showLoadingOverlay('Uploading file...');
                const filePath = `${userId}/mirs/${Date.now()}-${file.name}`;
                const uploadResult = await uploadFileToSupabase(file, 'documents', filePath);
                if (!uploadResult.success) {
                    return;
                }
                fileUrl = uploadResult.url;
                data.mir_document_url = fileUrl;
            }
            
            try {
                let result;
                if (docId) {
                    console.log(`[MIR] Updating existing document with ID: ${docId}`, data);
                    const currentDoc = mirData.find(d => d.id === docId);
                    if (currentDoc) {
                        data.mir_rev_status = currentDoc.mir_rev_status;
                    }
                    result = await saveDocument('mir', docId, data);
                } else {
                    console.log("[MIR] Adding new document or a new revision:", data);
                    const existingLatestMir = mirData.filter(d =>
                        d.mir_number === data.mir_number &&
                        d.mir_discipline === data.mir_discipline &&
                        d.mir_rev_status === 'Latest'
                    );
                    let previousLatestDoc = null;
                    if (existingLatestMir.length > 0) {
                        existingLatestMir.sort((a, b) => compareRevisions(a.mir_revision, b.mir_revision));
                        previousLatestDoc = existingLatestMir[existingLatestMir.length - 1];
                    }

                    if (previousLatestDoc && compareRevisions(data.mir_revision, previousLatestDoc.mir_revision) > 0) {
                        console.log(`[MIR] Marking previous latest MIR (${previousLatestDoc.id}) as Superseded.`);
                        await saveDocument('mir', previousLatestDoc.id, { mir_rev_status: 'Superseded' });
                    } else if (previousLatestDoc && compareRevisions(data.mir_revision, previousLatestDoc.mir_revision) < 0) {
                        showMessageModal("The revision you are adding is older than an existing 'Latest' revision for this MIR Number and Discipline. Please check the revision number.", "Warning: Older Revision");
                        data.mir_rev_status = 'Superseded';
                    }

                    data.mir_rev_status = 'Latest';
                    result = await addDocument('mir', data);
                }

                if (result.success) {
                    showMessageModal("MIR document saved successfully!", "Success");
                    clearMirForm();
                    await fetchAndRenderData('mir'); // Manually trigger re-render
                } else {
                    console.error("[MIR] Document operation failed:", result.error);
                }
            } catch (e) {
                console.error("[MIR] Unhandled error during document operation:", e);
                showMessageModal("An unexpected error occurred during MIR document operation: " + e.message, "Operation Error");
            }
        }

        function clearMirForm() {
            document.getElementById('mirForm').reset();
            document.getElementById('mirForm').removeAttribute('data-doc-id');
            document.getElementById('addUpdateMirButton').textContent = 'Add Document';
            document.getElementById('mirRevStatus').value = '';
            updateNextMirNumber();
            console.log("[MIR] Form cleared.");
        }

        async function editMir(docId) {
            showLoadingOverlay('Loading MIR data...');
            if (!supabase || !userId) {
                showMessageModal("Application not fully loaded or Supabase not connected. Please wait and try again.", "Error");
                hideLoadingOverlay();
                return;
            }
            try {
                const { data, error } = await supabase
                    .from('mir')
                    .select('*')
                    .eq('id', docId)
                    .single();
                if (error) throw error;
                if (data) {
                    document.getElementById('mirDate').value = formatDateForInput(data.mir_date) || '';
                    document.getElementById('mirNumber').value = data.mir_number || '';
                    document.getElementById('mirRevision').value = data.mir_revision || '';
                    document.getElementById('mirDiscipline').value = data.mir_discipline || '';
                    document.getElementById('dateMaterialReceived').value = formatDateForInput(data.date_material_received) || '';
                    document.getElementById('mirInspectionDate').value = formatDateForInput(data.mir_inspection_date) || '';
                    document.getElementById('mirInspectionTime').value = data.mir_inspection_time || '';
                    document.getElementById('materialApprovalRef').value = data.material_approval_ref || '';
                    document.getElementById('descriptionMaterial').value = data.description_material || '';
                    document.getElementById('deliveryNoteNumber').value = data.delivery_note_number || '';
                    document.getElementById('manufacturer').value = data.manufacturer || '';
                    document.getElementById('supplier').value = data.supplier || '';
                    document.getElementById('countryOrigin').value = data.country_origin || '';
                    document.getElementById('mirSubmissionDate').value = formatDateForInput(data.mir_submission_date) || '';
                    document.getElementById('mirResponseDate').value = formatDateForInput(data.mir_response_date) || '';
                    document.getElementById('mirApprovalStatus').value = data.mir_approval_status || '';
                    document.getElementById('mirRevStatus').value = data.mir_rev_status || '';

                    document.getElementById('mirForm').dataset.docId = docId;
                    document.getElementById('addUpdateMirButton').textContent = 'Update Document';
                    window.scrollTo(0, 0);
                    console.log(`[MIR] Data for ${docId} loaded into form for editing.`);
                } else {
                    console.error("No such MIR document!");
                    showMessageModal("Document not found for editing.", "Error");
                }
            } catch (error) {
                console.error("Error fetching MIR document for edit:", error);
                showMessageModal("Error loading document for editing: " + error.message, "Error");
            } finally {
                hideLoadingOverlay();
            }
        }

        async function updateNextInsNumber() {
            if (!supabase || !userId) {
                document.getElementById('nextInsNumber').textContent = 'Loading...';
                return;
            }
            const disciplineSelect = document.getElementById('discipline');
            const discipline = disciplineSelect ? disciplineSelect.value : '';
            if (discipline) {
                const nextNumber = await generateNextDocNumber('inspections', 'CP837-INS', 'ins_number', discipline);
                document.getElementById('nextInsNumber').textContent = nextNumber;
            } else {
                document.getElementById('nextInsNumber').textContent = 'Select Discipline';
            }
        }

        async function updateNextMirNumber() {
            if (!supabase || !userId) {
                document.getElementById('nextMirNumber').textContent = 'Loading...';
                return;
            }
            const disciplineSelect = document.getElementById('mirDiscipline');
            const discipline = disciplineSelect ? disciplineSelect.value : '';
            if (discipline) {
                const nextNumber = await generateNextDocNumber('mir', 'CP837-MIR', 'mir_number', discipline);
                document.getElementById('nextMirNumber').textContent = nextNumber;
            } else {
                document.getElementById('nextMirNumber').textContent = 'Select Discipline';
            }
        }

        async function handleNcrFormSubmission() {
            if (!userId) {
                showMessageModal("You must be signed in to add a document.", "Authentication Required");
                return;
            }
            console.log("[NCR] Starting handleNcrFormSubmission...");
            const form = document.getElementById('ncrForm');
            const docId = form.dataset.docId;
            const fileInput = document.getElementById('ncrDocument');
            const file = fileInput.files[0];
            let fileUrl = '';
            
            const partAReceivedDateValue = document.getElementById('partAReceivedDate').value;
            const partBSubmittedDateValue = document.getElementById('partBSubmittedDate').value;
            const partCReceivedDateValue = document.getElementById('partCReceivedDate').value;
            const partDSubmittedDateValue = document.getElementById('partDSubmittedDate').value;
            const partEReceivedDateValue = document.getElementById('partEReceivedDate').value;

            const data = {
                ncr_discipline: document.getElementById('ncrDiscipline').value,
                ncr_ref_number: document.getElementById('ncrRefNumber').value,
                ncr_description: document.getElementById('ncrDescription').value,
                part_a_received_date: partAReceivedDateValue ? partAReceivedDateValue : null,
                ncr_rev_part_b: document.getElementById('ncrRev_PartB').value,
                ncr_revised_parts_part_b: document.getElementById('ncrRevisedParts_PartB').value,
                immediate_action: document.getElementById('immediateAction').value,
                root_cause: document.getElementById('rootCause').value,
                corrective_action: document.getElementById('correctiveAction').value,
                part_b_submitted_date: partBSubmittedDateValue ? partBSubmittedDateValue : null,
                part_c_received_date: partCReceivedDateValue ? partCReceivedDateValue : null,
                part_b_accepted_by_gec: document.getElementById('partBAcceptedByGEC').value,
                if_part_b_accepted: document.getElementById('ifPartBAccepted').value,
                part_d_rev: document.getElementById('partDRev').value,
                part_d_revised_parts: document.getElementById('partDRevisedParts').value,
                part_d_submitted_date: partDSubmittedDateValue ? partDSubmittedDateValue : null,
                part_e_received_date: partEReceivedDateValue ? partEReceivedDateValue : null,
                part_e_status: document.getElementById('partEStatus').value,
                ncr_current_status: document.getElementById('ncrCurrentStatus').value,
                user_id: userId
            };
            if (!data.ncr_discipline || !data.ncr_ref_number || (data.ncr_rev_part_b === null || data.ncr_rev_part_b === undefined || data.ncr_rev_part_b === '')) {
                showMessageModal("Please fill in required fields: Discipline, NCR Ref. Number, and Part B Revision.", "Missing Information");
                console.warn("[NCR] Required fields missing. Operation aborted.");
                return;
            }

            if (file) {
                showLoadingOverlay('Uploading file...');
                const filePath = `${userId}/ncrs/${Date.now()}-${file.name}`;
                const uploadResult = await uploadFileToSupabase(file, 'documents', filePath);
                if (!uploadResult.success) {
                    return;
                }
                fileUrl = uploadResult.url;
                data.ncr_document_url = fileUrl;
            }

            try {
                let result;
                if (docId) {
                    console.log(`[NCR] Updating existing NCR document with ID: ${docId}`, data);
                    result = await saveDocument('ncr', docId, data);
                    if (result.success) {
                        showMessageModal("NCR document updated successfully!", "Success");
                    }
                } else {
                    const existingLatestNCRS = ncrData.filter(d =>
                        d.ncr_ref_number === data.ncr_ref_number &&
                        d.ncr_discipline === data.ncr_discipline &&
                        d.ncr_lifecycle_status === 'Latest'
                    );
                    if (existingLatestNCRS.length > 0) {
                        existingLatestNCRS.sort((a, b) => compareRevisions(a.ncr_rev_part_b, b.ncr_rev_part_b));
                        const previousLatestNcr = existingLatestNCRS[existingLatestNCRS.length - 1];

                        console.log(`[NCR] Marking previous latest NCR (${previousLatestNcr.id}) as Superseded.`);
                        await saveDocument('ncr', previousLatestNcr.id, { ncr_lifecycle_status: 'Superseded' });
                    }

                    data.ncr_lifecycle_status = 'Latest';
                    if (!data.ncr_rev_part_b) {
                        data.ncr_rev_part_b = '0';
                    }
                    console.log("[NCR] Adding new NCR (or revision) document:", data);
                    result = await addDocument('ncr', data);
                    if (result.success) {
                        showMessageModal("New NCR (or revision) added successfully!", "Success");
                    }
                }

                if (result.success) {
                    clearNcrForm();
                    await fetchAndRenderData('ncr'); // Manually trigger re-render
                } else {
                    console.error("[NCR] Document operation failed:", result.error);
                }
            } catch (e) {
                console.error("[NCR] Unhandled error during document operation:", e);
                showMessageModal("An unexpected error occurred during NCR document operation: " + e.message, "Operation Error");
            }
        }

        function clearNcrForm() {
            const form = document.getElementById('ncrForm');
            form.reset();
            form.removeAttribute('data-doc-id');
            document.getElementById('addUpdateNcrButton').textContent = 'Add Document';
            document.getElementById('ifPartBAccepted').value = '';
            document.getElementById('ncrRev_PartB').value = '0';
            document.getElementById('partDRev').value = '';
            document.getElementById('partDRevisedParts').value = '';
            console.log("[NCR] Form cleared.");
        }

        function fillNcrForm(data, docId = null, forNewRevision = false) {
            document.getElementById('ncrDiscipline').value = data.ncr_discipline || '';
            document.getElementById('ncrRefNumber').value = data.ncr_ref_number || '';
            document.getElementById('ncrDescription').value = data.ncr_description || '';
            document.getElementById('partAReceivedDate').value = formatDateForInput(data.part_a_received_date) || '';
            if (forNewRevision) {
                document.getElementById('ncrRev_PartB').value = getNextRevision(data.ncr_rev_part_b || '0');
                document.getElementById('ncrRevisedParts_PartB').value = '';
                document.getElementById('immediateAction').value = '';
                document.getElementById('rootCause').value = '';
                document.getElementById('correctiveAction').value = '';
                document.getElementById('partBSubmittedDate').value = '';
            } else {
                document.getElementById('ncrRev_PartB').value = data.ncr_rev_part_b || '';
                document.getElementById('ncrRevisedParts_PartB').value = data.ncr_revised_parts_part_b || '';
                document.getElementById('immediateAction').value = data.immediate_action || '';
                document.getElementById('rootCause').value = data.root_cause || '';
                document.getElementById('correctiveAction').value = data.corrective_action || '';
                document.getElementById('partBSubmittedDate').value = formatDateForInput(data.part_b_submitted_date) || '';
            }

            document.getElementById('partCReceivedDate').value = formatDateForInput(data.part_c_received_date) || '';
            document.getElementById('partBAcceptedByGEC').value = data.part_b_accepted_by_gec || '';

            if (forNewRevision) {
                document.getElementById('partDRev').value = '';
                document.getElementById('partDRevisedParts').value = '';
                document.getElementById('partDSubmittedDate').value = '';
                document.getElementById('partEReceivedDate').value = '';
                document.getElementById('partEStatus').value = '';
                document.getElementById('ncrCurrentStatus').value = '';
            } else {
                document.getElementById('partDRev').value = data.part_d_rev || '';
                document.getElementById('partDRevisedParts').value = data.part_d_revised_parts || '';
                document.getElementById('partDSubmittedDate').value = formatDateForInput(data.part_d_submitted_date) || '';
                document.getElementById('partEReceivedDate').value = formatDateForInput(data.part_e_received_date) || '';
                document.getElementById('partEStatus').value = data.part_e_status || '';
                document.getElementById('ncrCurrentStatus').value = data.ncr_current_status || '';
            }

            const formElement = document.getElementById('ncrForm');
            const addButton = document.getElementById('addUpdateNcrButton');

            if (docId) {
                formElement.dataset.docId = docId;
                addButton.textContent = 'Update Document';
            } else {
                formElement.removeAttribute('data-doc-id');
                addButton.textContent = 'Add Document';
            }

            document.getElementById('partBAcceptedByGEC').dispatchEvent(new Event('change'));
            window.scrollTo(0, 0);
            console.log(`[NCR] Form filled for ${docId ? 'editing' : 'new revision'}.`);
        }

        async function autoFillNcrDetails() {
            console.log("[NCR] Starting autoFillNcrDetails...");
            const ncrRefNumber = document.getElementById('ncrRefNumber').value.trim();
            const ncrDiscipline = document.getElementById('ncrDiscipline').value;

            if (!ncrRefNumber || !ncrDiscipline) {
                clearNcrForm();
                document.getElementById('ncrRefNumber').value = ncrRefNumber;
                document.getElementById('ncrDiscipline').value = ncrDiscipline;
                console.log("[NCR] NCR Ref Number or Discipline is empty. Form cleared for new entry.");
                return;
            }

            if (!supabase || !userId) {
                console.warn("Supabase or User ID not ready for auto-fill.");
                showMessageModal("Application not fully loaded or Supabase not connected. Cannot auto-fill.", "Error");
                return;
            }

            const matchingNCRS = ncrData.filter(doc =>
                doc.ncr_ref_number === ncrRefNumber &&
                doc.ncr_discipline === ncrDiscipline
            );
            if (matchingNCRS.length > 0) {
                matchingNCRS.sort((a, b) => compareRevisions(a.ncr_rev_part_b, b.ncr_rev_part_b));
                const latestNcr = matchingNCRS[matchingNCRS.length - 1];

                fillNcrForm(latestNcr, null, true);
                showMessageModal("Latest NCR revision loaded automatically. Part B Rev. incremented for new entry. Fill new details to add new revision.", "New NCR Revision");
                console.log("[NCR] Latest NCR revision found and loaded for new revision entry.");
            } else {
                const originalNcrRefNumber = document.getElementById('ncrRefNumber').value;
                const originalNcrDiscipline = document.getElementById('ncrDiscipline').value;

                clearNcrForm();

                document.getElementById('ncrRefNumber').value = originalNcrRefNumber;
                document.getElementById('ncrDiscipline').value = originalNcrDiscipline;

                showMessageModal("This NCR Ref. Number for the selected discipline is new. Please fill details to add. Part B Revision defaults to '0'.", "New NCR");
                console.log("[NCR] No existing NCR found. Form reset for new NCR entry.");
            }
        }


        async function editNcr(docId) {
            showLoadingOverlay('Loading NCR data...');
            if (!supabase || !userId) {
                showMessageModal("Application not fully loaded or Supabase not connected. Please wait and try again.", "Error");
                hideLoadingOverlay();
                return;
            }
            try {
                const { data, error } = await supabase
                    .from('ncr')
                    .select('*')
                    .eq('id', docId)
                    .single();
                if (error) throw error;
                if (data) {
                    fillNcrForm(data, docId, false);
                    console.log(`[NCR] Data for ${docId} loaded into form for editing.`);
                } else {
                    console.error("No such NCR document!");
                    showMessageModal("Document not found for editing.", "Error");
                }
            } catch (error) {
                console.error("Error fetching NCR document for edit:", error);
                showMessageModal("Error loading document for editing: " + error.message, "Error");
            } finally {
                hideLoadingOverlay();
            }
        }

        // Submission Register
        async function addNewSubmissionDocument() {
            if (!userId) {
                showMessageModal("You must be signed in to add a document.", "Authentication Required");
                return;
            }
            console.log("[Submission] Starting addNewSubmissionDocument...");
            const form = document.getElementById('submissionForm');
            const docId = form.dataset.docId;
            const fileInput = document.getElementById('submissionDocument');
            const file = fileInput.files[0];
            let fileUrl = '';

            const respondedDateValue = document.getElementById('newRespondedDate').value;
            const gecDueDateValue = document.getElementById('gecDueDate').value;

            const data = {
                doc_number: document.getElementById('newDocNumber').value,
                rev: document.getElementById('newRev').value,
                discipline: document.getElementById('newDiscipline').value,
                doc_type: document.getElementById('newDocType').value,
                section: document.getElementById('newSection').value,
                doc_title: document.getElementById('newDocTitle').value,
                sub_ref: document.getElementById('newSubRef').value,
                submitted_date: document.getElementById('newSubmittedDate').value,
                responded_date: respondedDateValue ? respondedDateValue : null,
                gec_due_date: gecDueDateValue ? gecDueDateValue : null,
                status: document.getElementById('newStatus').value,
                verify_rev: 'Latest',
                days_overdue: calculateDaysOverdue(document.getElementById('newSubmittedDate').value, respondedDateValue),
                user_id: userId
            };
            if (!data.doc_number || !data.rev || !data.discipline || !data.doc_type || !data.doc_title || !data.submitted_date) {
                showMessageModal("Please fill in all required fields for Submission: Document Number, Revision, Discipline, Document Type, Document Title, Submitted Date.", "Missing Information");
                console.warn("[Submission] Required fields missing. Operation aborted.");
                return;
            }

            if (file) {
                showLoadingOverlay('Uploading file...');
                const filePath = `${userId}/submissions/${Date.now()}-${file.name}`;
                const uploadResult = await uploadFileToSupabase(file, 'documents', filePath);
                if (!uploadResult.success) {
                    return;
                }
                fileUrl = uploadResult.url;
                data.document_url = fileUrl;
            }

            console.log("[Submission] Attempting to add/update document. docId:", docId, "Data:", JSON.stringify(data));
            try {
                let result;
                if (docId) {
                    console.log(`[Submission] Updating existing document with ID: ${docId}. Its lifecycle status will be preserved.`);
                    const existingDoc = submissionData.find(d => d.id === docId);
                    if (existingDoc) {
                        data.verify_rev = existingDoc.verify_rev;
                    }
                    result = await saveDocument('submissions', docId, data);
                    if (result.success) {
                        showMessageModal("Submission document updated successfully!", "Success");
                        clearNewSubmissionDocumentForm();
                    } else {
                        console.error("[Submission] Document update failed:", result.error);
                    }
                } else {
                    console.log("[Submission] Adding new document or new revision.");
                    const existingLatestCandidates = submissionData.filter(d =>
                        d.doc_number === data.doc_number &&
                        d.discipline === data.discipline &&
                        (d.verify_rev !== 'Superseded' && d.verify_rev !== 'superseded')
                    );
                    let previousLatestDoc = null;
                    if (existingLatestCandidates.length > 0) {
                        existingLatestCandidates.sort((a, b) => compareRevisions(a.rev, b.rev));
                        previousLatestDoc = existingLatestCandidates[existingLatestCandidates.length - 1];
                    }

                    if (previousLatestDoc) {
                        const comparisonResult = compareRevisions(data.rev, previousLatestDoc.rev);
                        if (comparisonResult > 0) {
                            const supersedeResult = await saveDocument('submissions', previousLatestDoc.id, { verify_rev: 'Superseded' });
                            if (!supersedeResult.success) {
                                showMessageModal("Failed to mark previous document as superseded. Data inconsistency may occur.", "Supersede Error");
                                console.error("[Submission] Supersede operation failed:", supersedeResult.error);
                            } else {
                                console.log(`[Submission] Previous document ${previousLatestDoc.id} successfully superseded.`);
                            }
                            data.verify_rev = 'Latest';
                        } else if (comparisonResult < 0) {
                            showMessageModal("The revision you are adding is older than an existing 'Latest' revision for this Document Number and Discipline. It will be added as 'Superseded'.", "Warning: Older Revision");
                            data.verify_rev = 'Superseded';
                        } else {
                            showMessageModal("A document with the exact same Document Number, Discipline, and Revision already exists and is not 'Superseded'. This new entry will be added as 'Superseded'. If you intended to edit, please use the 'Edit' button for the existing document.", "Warning: Duplicate Revision");
                            data.verify_rev = 'Superseded';
                        }
                    } else {
                        data.verify_rev = 'Latest';
                    }

                    result = await addDocument('submissions', data);
                    if (result.success) {
                        showMessageModal("New submission document added successfully!", "Success");
                        clearNewSubmissionDocumentForm();
                        await fetchAndRenderData('submissions'); // Manually trigger re-render
                    } else {
                        console.error("[Submission] Document add failed:", result.error);
                    }
                }
            } catch (e) {
                console.error("[Submission] Unhandled error during document operation:", e);
                showMessageModal("An unexpected error occurred during submission document operation: " + e.message, "Operation Error");
            }
        }

        function clearNewSubmissionDocumentForm() {
            const form = document.getElementById('submissionForm');
            form.reset();
            form.removeAttribute('data-doc-id');
            document.querySelector('#submissionForm button.action-button').textContent = 'Add Document';
            document.getElementById('lifecycleStatus').value = '';
            document.getElementById('daysOverdue').value = '';
            document.getElementById('gecDueDate').value = '';
            console.log("[Submission] Form cleared.");
        }

        async function editSubmission(docId) {
            showLoadingOverlay('Loading submission data...');
            if (!supabase || !userId) {
                showMessageModal("Application not fully loaded or Supabase not connected. Please wait and try again.", "Error");
                hideLoadingOverlay();
                return;
            }
            try {
                const { data, error } = await supabase
                    .from('submissions')
                    .select('*')
                    .eq('id', docId)
                    .single();
                if (error) throw error;
                if (data) {
                    document.getElementById('newDocNumber').value = data.doc_number || '';
                    document.getElementById('newRev').value = data.rev || '';
                    document.getElementById('newDiscipline').value = data.discipline || '';
                    document.getElementById('newDocType').value = data.doc_type || '';
                    document.getElementById('newSection').value = data.section || '';
                    document.getElementById('newDocTitle').value = data.doc_title || '';
                    document.getElementById('newSubRef').value = data.sub_ref || '';
                    document.getElementById('newSubmittedDate').value = formatDateForInput(data.submitted_date) || '';
                    document.getElementById('newRespondedDate').value = formatDateForInput(data.responded_date) || '';
                    document.getElementById('newStatus').value = data.status || '';
                    document.getElementById('lifecycleStatus').value = data.verify_rev || '';
                    document.getElementById('daysOverdue').value = data.days_overdue || '';
                    document.getElementById('gecDueDate').value = formatDateForInput(data.gec_due_date) || '';

                    const form = document.getElementById('submissionForm');
                    form.dataset.docId = docId;
                    document.querySelector('#submissionForm button.action-button').textContent = 'Update Document';
                    window.scrollTo(0, 0);
                    console.log(`[Submission] Data for ${docId} loaded into form for editing.`);
                } else {
                    console.error("No such submission document!");
                    showMessageModal("Document not found for editing.", "Error");
                }
            } catch (error) {
                console.error("Error fetching submission document for edit:", error);
                showMessageModal("Error loading document for editing: " + error.message, "Error");
            } finally {
                hideLoadingOverlay();
            }
        }

        // Correspondence Register - Outgoing
        async function addNewOutgoingCorrespondence() {
            if (!userId) {
                showMessageModal("You must be signed in to add a document.", "Authentication Required");
                return;
            }
            console.log("[Outgoing Correspondence] Starting addNewOutgoingCorrespondence...");
            const form = document.getElementById('outgoingCorrespondenceForm');
            const docId = form.dataset.docId;
            const fileInput = document.getElementById('outgoingDocument');
            const file = fileInput.files[0];
            let fileUrl = '';
            
            const newOutgoingLetterDateValue = document.getElementById('newOutgoingLetterDate').value;
            const newOutgoingDateSentValue = document.getElementById('newOutgoingDateSent').value;

            const data = {
                initiator: document.getElementById('newOutgoingInitiator').value,
                addressee: document.getElementById('newOutgoingAddressee').value,
                letter_ref: document.getElementById('newOutgoingLetterRef').value,
                letter_date: newOutgoingLetterDateValue ? newOutgoingLetterDateValue : null,
                letter_subject: document.getElementById('newOutgoingLetterSubject').value,
                in_reply_to_ref: document.getElementById('newOutgoingInReplyToRef').value,
                keyword: document.getElementById('newOutgoingKeyword').value,
                reply_required: document.getElementById('newOutgoingReplyRequired').value,
                date_sent: newOutgoingDateSentValue ? newOutgoingDateSentValue : null,
                status: document.getElementById('newOutgoingReplyRequired').value === 'Yes' ? 'OPEN' : 'CLOSED',
                user_id: userId
            };
            if (!data.letter_ref || !data.letter_subject || !data.reply_required) {
                showMessageModal("Please fill in all required fields for Outgoing Correspondence: Outgoing Letter Ref., Letter Subject, Reply Required.", "Missing Information");
                console.warn("[Outgoing Correspondence] Required fields missing. Operation aborted.");
                return;
            }

            if (file) {
                showLoadingOverlay('Uploading file...');
                const filePath = `${userId}/outgoing_correspondences/${Date.now()}-${file.name}`;
                const uploadResult = await uploadFileToSupabase(file, 'documents', filePath);
                if (!uploadResult.success) {
                    return;
                }
                fileUrl = uploadResult.url;
                data.outgoing_document_url = fileUrl;
            }
            
            console.log("[Outgoing Correspondence] Attempting to add/update document. docId:", docId, "Data:", data);
            try {
                let result;
                if (docId) {
                    result = await saveDocument('outgoing_correspondences', docId, data);
                } else {
                    result = await addDocument('outgoing_correspondences', data);
                }

                if (result.success) {
                    showMessageModal("Outgoing correspondence saved successfully!", "Success");
                    clearNewOutgoingCorrespondenceForm();
                    await fetchAndRenderData('outgoing_correspondences'); // Manually trigger re-render
                } else {
                    console.error("[Outgoing Correspondence] Document operation failed:", result.error);
                }
            }
            catch (e) {
                console.error("[Outgoing Correspondence] Unhandled error during document operation:", e);
                showMessageModal("An unexpected error occurred during outgoing correspondence document operation: " + e.message, "Operation Error");
            }
        }

        function clearNewOutgoingCorrespondenceForm() {
            const form = document.getElementById('outgoingCorrespondenceForm');
            form.reset();
            form.removeAttribute('data-doc-id');
            document.querySelector('#outgoingCorrespondenceForm button.action-button').textContent = 'Add Outgoing';
            console.log("[Outgoing Correspondence] Form cleared.");
        }

        async function editOutgoing(docId) {
            showLoadingOverlay('Loading outgoing correspondence data...');
            if (!supabase || !userId) {
                showMessageModal("Application not fully loaded or Supabase not connected. Please wait and try again.", "Error");
                hideLoadingOverlay();
                return;
            }
            try {
                const { data, error } = await supabase
                    .from('outgoing_correspondences')
                    .select('*')
                    .eq('id', docId)
                    .single();
                if (error) throw error;
                if (data) {
                    document.getElementById('newOutgoingInitiator').value = data.initiator || '';
                    document.getElementById('newOutgoingAddressee').value = data.addressee || '';
                    document.getElementById('newOutgoingLetterRef').value = data.letter_ref || '';
                    document.getElementById('newOutgoingLetterDate').value = formatDateForInput(data.letter_date) || '';
                    document.getElementById('newOutgoingLetterSubject').value = data.letter_subject || '';
                    document.getElementById('newOutgoingInReplyToRef').value = data.in_reply_to_ref || '';
                    document.getElementById('newOutgoingKeyword').value = data.keyword || '';
                    document.getElementById('newOutgoingReplyRequired').value = data.reply_required || '';
                    document.getElementById('newOutgoingDateSent').value = formatDateForInput(data.date_sent) || '';

                    const form = document.getElementById('outgoingCorrespondenceForm');
                    form.dataset.docId = docId;
                    document.querySelector('#outgoingCorrespondenceForm button.action-button').textContent = 'Update Outgoing';
                    window.scrollTo(0, 0);
                    console.log(`[Outgoing Correspondence] Data for ${docId} loaded into form for editing.`);
                } else {
                    console.error("No such outgoing correspondence document!");
                    showMessageModal("Document not found for editing.", "Error");
                }
            } catch (error) {
                console.error("Error fetching outgoing correspondence document for edit:", error);
                showMessageModal("Error loading document for editing: " + error.message, "Error");
            } finally {
                hideLoadingOverlay();
            }
        }

        // Correspondence Register - Incoming
        async function addNewIncomingCorrespondence() {
            if (!userId) {
                showMessageModal("You must be signed in to add a document.", "Authentication Required");
                return;
            }
            console.log("[Incoming Correspondence] Starting addNewIncomingCorrespondence...");
            const form = document.getElementById('incomingCorrespondenceForm');
            const docId = form.dataset.docId;
            const fileInput = document.getElementById('incomingDocument');
            const file = fileInput.files[0];
            let fileUrl = '';
            
            const newIncomingDateOfReceiptValue = document.getElementById('newIncomingDateOfReceipt').value;

            const data = {
                incoming_ref: document.getElementById('newIncomingRef').value,
                date_of_receipt: newIncomingDateOfReceiptValue ? newIncomingDateOfReceiptValue : null,
                originator: document.getElementById('newIncomingOriginator').value,
                addressee: document.getElementById('newIncomingAddressee').value,
                letter_subject: document.getElementById('newIncomingLetterSubject').value,
                reply_to_ref: document.getElementById('newIncomingReplyToRef').value,
                keyword: document.getElementById('newIncomingKeyword').value,
                reply_required: document.getElementById('newIncomingReplyRequired').value,
                status: document.getElementById('newIncomingReplyRequired').value === 'Yes' ? 'OPEN' : 'CLOSED',
                user_id: userId
            };
            if (!data.incoming_ref || !data.letter_subject || !data.reply_required) {
                showMessageModal("Please fill in all required fields for Incoming Correspondence: Incoming Reference, Letter Subject, Reply Required.", "Missing Information");
                console.warn("[Incoming Correspondence] Required fields missing. Operation aborted.");
                return;
            }

            if (file) {
                showLoadingOverlay('Uploading file...');
                const filePath = `${userId}/incoming_correspondences/${Date.now()}-${file.name}`;
                const uploadResult = await uploadFileToSupabase(file, 'documents', filePath);
                if (!uploadResult.success) {
                    return;
                }
                fileUrl = uploadResult.url;
                data.incoming_document_url = fileUrl;
            }

            console.log("[Incoming Correspondence] Attempting to add/update document. docId:", docId, "Data:", data);
            try {
                let result;
                if (docId) {
                    result = await saveDocument('incoming_correspondences', docId, data);
                } else {
                    result = await addDocument('incoming_correspondences', data);
                }

                if (result.success) {
                    showMessageModal("Incoming correspondence saved successfully!", "Success");
                    clearNewIncomingCorrespondenceForm();
                    await fetchAndRenderData('incoming_correspondences'); // Manually trigger re-render
                } else {
                    console.error("[Incoming Correspondence] Document operation failed:", result.error);
                }
            } catch (e) {
                console.error("[Incoming Correspondence] Unhandled error during document operation:", e);
                showMessageModal("An unexpected error occurred during incoming correspondence document operation: " + e.message, "Operation Error");
            }
        }

        function clearNewIncomingCorrespondenceForm() {
            const form = document.getElementById('incomingCorrespondenceForm');
            form.reset();
            form.removeAttribute('data-doc-id');
            document.querySelector('#incomingCorrespondenceForm button.action-button').textContent = 'Add Incoming';
            console.log("[Incoming Correspondence] Form cleared.");
        }

        async function editIncoming(docId) {
            showLoadingOverlay('Loading incoming correspondence data...');
            if (!supabase || !userId) {
                showMessageModal("Application not fully loaded or Supabase not connected. Please wait and try again.", "Error");
                hideLoadingOverlay();
                return;
            }
            try {
                const { data, error } = await supabase
                    .from('incoming_correspondences')
                    .select('*')
                    .eq('id', docId)
                    .single();
                if (error) throw error;
                if (data) {
                    document.getElementById('newIncomingRef').value = data.incoming_ref || '';
                    document.getElementById('newIncomingDateOfReceipt').value = formatDateForInput(data.date_of_receipt) || '';
                    document.getElementById('newIncomingOriginator').value = data.originator || '';
                    document.getElementById('newIncomingAddressee').value = data.addressee || '';
                    document.getElementById('newIncomingLetterSubject').value = data.letter_subject || '';
                    document.getElementById('newIncomingReplyToRef').value = data.reply_to_ref || '';
                    document.getElementById('newIncomingKeyword').value = data.keyword || '';
                    document.getElementById('newIncomingReplyRequired').value = data.reply_required || '';
                    
                    const form = document.getElementById('incomingCorrespondenceForm');
                    form.dataset.docId = docId;
                    document.querySelector('#incomingCorrespondenceForm button.action-button').textContent = 'Update Incoming';
                    window.scrollTo(0, 0);
                    console.log(`[Incoming Correspondence] Data for ${docId} loaded into form for editing.`);
                } else {
                    console.error("No such incoming correspondence document!");
                    showMessageModal("Document not found for editing.", "Error");
                }
            } catch (error) {
                console.error("Error fetching incoming correspondence document for edit:", error);
                showMessageModal("Error loading document for editing: " + error.message, "Error");
            } finally {
                hideLoadingOverlay();
            }
        }

        // --- Staff Emails Management ---
        async function addUpdateStaffEmail() {
            if (!userId) {
                showMessageModal("You must be signed in to add a document.", "Authentication Required");
                return;
            }
            const name = document.getElementById('staffEmailName').value;
            const email = document.getElementById('staffEmailAddress').value;
            const docId = document.getElementById('staffEmailForm').dataset.docId;

            if (!name || !email) {
                showMessageModal("Please enter both staff name and email address.", "Missing Information");
                return;
            }

            const data = { name, email, user_id: userId };
            const tableName = 'staff_emails';
            let result;

            if (docId) {
                result = await saveDocument(tableName, docId, data);
            } else {
                result = await addDocument(tableName, data);
            }

            if (result.success) {
                showMessageModal("Staff email saved successfully!", "Success");
                clearStaffForm();
                await fetchAndRenderData('staff_emails'); // Manually trigger re-render
            } else {
                showMessageModal("Error saving staff email: " + result.error.message, "Error");
            }
        }

        async function editStaffEmail(docId) {
            staffEditingEmailId = docId;
            const staff = staffEmailsData.find(d => d.id === docId);
            if (staff) {
                document.getElementById('staffEmailName').value = staff.name;
                document.getElementById('staffEmailAddress').value = staff.email;
                document.getElementById('staffEmailForm').dataset.docId = docId;
                document.getElementById('addUpdateStaffButton').textContent = 'Update Staff';
                window.scrollTo(0, 0);
            }
        }

        async function deleteStaffEmail(docId) {
            await deleteDocument('staff_emails', docId);
            await fetchAndRenderData('staff_emails'); // Manually trigger re-render
        }

        function clearStaffForm() {
            document.getElementById('staffEmailForm').reset();
            document.getElementById('staffEmailForm').removeAttribute('data-doc-id');
            document.getElementById('addUpdateStaffButton').textContent = 'Save Staff';
            staffEditingEmailId = null;
        }

        function renderStaffEmails() {
            const tableBody = document.querySelector('#staffEmailsTable tbody');
            tableBody.innerHTML = '';
            staffEmailsData.forEach(staff => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${staff.name || ''}</td>
                    <td>${staff.email || ''}</td>
                    <td class="action-buttons">
                        <button class="edit-button" onclick="editStaffEmail('${staff.id}')">Edit</button>
                        <button class="danger-button" onclick="deleteDocument('staff_emails', '${staff.id}')">Delete</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // --- Render Table Rows with Email button ---

        function renderInspectionRow(doc, collectionName) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${formatDateForDisplay(doc.date)}</td>
                <td>${doc.discipline || ''}</td>
                <td>${doc.ins_number || ''}</td>
                <td>${doc.revision || ''}</td>
                <td>${doc.location || ''}</td>
                <td>${doc.work_to_be_inspected || ''}</td>
                <td>${formatDateForDisplay(doc.inspection_date)}</td>
                <td>${doc.inspection_time || ''}</td>
                <td>${doc.approved_drawing_ref || ''}</td>
                <td>${doc.specification_ref || ''}</td>
                <td>${doc.approved_method_statement_ref || ''}</td>
                <td>${doc.qcs_reference || ''}</td>
                <td>${doc.document_status || ''}</td>
                <td>${doc.rev_status || ''}</td>
                <td class="action-buttons">
                    <button class="edit-button" onclick="editInspection('${doc.id}')">Edit</button>
                    <button class="danger-button" onclick="deleteDocument('inspections', '${doc.id}')">Delete</button>
                    <button class="email-button" onclick="showEmailModal({ id: '${doc.id}' }, 'inspections')"><i class="fas fa-envelope"></i></button>
                </td>
            `;
            return tr;
        }

        function renderMirRow(doc, collectionName) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${formatDateForDisplay(doc.mir_date)}</td>
                <td>${doc.mir_discipline || ''}</td>
                <td>${doc.mir_number || ''}</td>
                <td>${doc.mir_revision || ''}</td>
                <td>${formatDateForDisplay(doc.date_material_received)}</td>
                <td>${formatDateForDisplay(doc.mir_inspection_date)}</td>
                <td>${doc.mir_inspection_time || ''}</td>
                <td>${doc.material_approval_ref || ''}</td>
                <td>${doc.description_material || ''}</td>
                <td>${doc.delivery_note_number || ''}</td>
                <td>${doc.manufacturer || ''}</td>
                <td>${doc.supplier || ''}</td>
                <td>${doc.country_origin || ''}</td>
                <td>${formatDateForDisplay(doc.mir_submission_date)}</td>
                <td>${formatDateForDisplay(doc.mir_response_date)}</td>
                <td>${doc.mir_approval_status || ''}</td>
                <td>${doc.mir_rev_status || ''}</td>
                <td class="action-buttons">
                    <button class="edit-button" onclick="editMir('${doc.id}')">Edit</button>
                    <button class="danger-button" onclick="deleteDocument('mir', '${doc.id}')">Delete</button>
                    <button class="email-button" onclick="showEmailModal({ id: '${doc.id}' }, 'mir')"><i class="fas fa-envelope"></i></button>
                </td>
            `;
            return tr;
        }

        function renderNcrRow(doc, collectionName) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${doc.ncr_ref_number || ''}</td>
                <td>${doc.ncr_discipline || ''}</td>
                <td>${doc.ncr_lifecycle_status || ''}</td>
                <td>${doc.ncr_description || ''}</td>
                <td>${formatDateForDisplay(doc.part_a_received_date)}</td>
                <td>${doc.ncr_rev_part_b || ''}</td>
                <td>${doc.ncr_revised_parts_part_b || ''}</td>
                <td>${doc.immediate_action || ''}</td>
                <td>${doc.root_cause || ''}</td>
                <td>${doc.corrective_action || ''}</td>
                <td>${formatDateForDisplay(doc.part_b_submitted_date)}</td>
                <td>${formatDateForDisplay(doc.part_c_received_date)}</td>
                <td>${doc.part_b_accepted_by_gec || ''}</td>
                <td>${doc.if_part_b_accepted || ''}</td>
                <td>${doc.part_d_rev || ''}</td>
                <td>${doc.part_d_revised_parts || ''}</td>
                <td>${formatDateForDisplay(doc.part_d_submitted_date)}</td>
                <td>${doc.part_e_received_date || ''}</td>
                <td>${doc.part_e_status || ''}</td>
                <td>${doc.ncr_current_status || ''}</td>
                <td class="action-buttons">
                    <button class="edit-button" onclick="editNcr('${doc.id}')">Edit</button>
                    <button class="danger-button" onclick="deleteDocument('ncr', '${doc.id}')">Delete</button>
                    <button class="email-button" onclick="showEmailModal({ id: '${doc.id}' }, 'ncr')"><i class="fas fa-envelope"></i></button>
                </td>
            `;
            return tr;
        }

        function renderSubmissionRow(doc, collectionName) {
            const tr = document.createElement('tr');
            let lifecycleStatusForDisplay = '';
            if (doc.verify_rev) {
                const match = doc.verify_rev.match(/^(Latest|Superseded)/i);
                if (match) {
                    lifecycleStatusForDisplay = match[0];
                } else {
                    lifecycleStatusForDisplay = doc.verify_rev;
                }
            }

            tr.innerHTML = `
                <td>${doc.doc_number || ''}</td>
                <td>${doc.rev || ''}</td>
                <td>${doc.discipline || ''}</td>
                <td>${doc.doc_type || ''}</td>
                <td>${doc.section || ''}</td>
                <td>${doc.doc_title || ''}</td>
                <td>${doc.sub_ref || ''}</td>
                <td>${formatDateForDisplay(doc.submitted_date)}</td>
                <td>${formatDateForDisplay(doc.gec_due_date)}</td>
                <td>${formatDateForDisplay(doc.responded_date)}</td>
                <td>${doc.status || ''}</td>
                <td>${lifecycleStatusForDisplay}</td>
                <td>${doc.days_overdue || ''}</td>
                <td class="action-buttons">
                    <button class="edit-button" onclick="editSubmission('${doc.id}')">Edit</button>
                    <button class="danger-button" onclick="deleteDocument('submissions', '${doc.id}')">Delete</button>
                    <button class="email-button" onclick="showEmailModal({ id: '${doc.id}' }, 'submissions')"><i class="fas fa-envelope"></i></button>
                </td>
            `;
            return tr;
        }

        function renderOutgoingCorrespondenceRow(doc, collectionName) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${doc.initiator || ''}</td>
                <td>${doc.addressee || ''}</td>
                <td>${doc.letter_ref || ''}</td>
                <td>${formatDateForDisplay(doc.letter_date)}</td>
                <td>${doc.letter_subject || ''}</td>
                <td>${doc.in_reply_to_ref || ''}</td>
                <td>${doc.keyword || ''}</td>
                <td>${doc.reply_required || ''}</td>
                <td>${formatDateForDisplay(doc.date_sent)}</td>
                <td>${doc.status || ''}</td>
                <td class="action-buttons">
                    <button class="edit-button" onclick="editOutgoing('${doc.id}')">Edit</button>
                    <button class="danger-button" onclick="deleteDocument('outgoing_correspondences', '${doc.id}')">Delete</button>
                    <button class="email-button" onclick="showEmailModal({ id: '${doc.id}' }, 'outgoing_correspondences')"><i class="fas fa-envelope"></i></button>
                </td>
            `;
            return tr;
        }

        function renderIncomingCorrespondenceRow(doc, collectionName) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${doc.incoming_ref || ''}</td>
                <td>${formatDateForDisplay(doc.date_of_receipt)}</td>
                <td>${doc.originator || ''}</td>
                <td>${doc.addressee || ''}</td>
                <td>${doc.letter_subject || ''}</td>
                <td>${doc.reply_to_ref || ''}</td>
                <td>${doc.keyword || ''}</td>
                <td>${doc.reply_required || ''}</td>
                <td>${doc.status || ''}</td>
                <td class="action-buttons">
                    <button class="edit-button" onclick="editIncoming('${doc.id}')">Edit</button>
                    <button class="danger-button" onclick="deleteDocument('incoming_correspondences', '${doc.id}')">Delete</button>
                    <button class="email-button" onclick="showEmailModal({ id: '${doc.id}' }, 'incoming_correspondences')"><i class="fas fa-envelope"></i></button>
                </td>
            `;
            return tr;
        }

        // --- Search and Filter Functions (client-side for simplicity) ---
        function performInspectionsSearch() {
            const tableBody = document.querySelector('#inspectionsTable tbody');
            tableBody.innerHTML = '';
            const field = document.getElementById('inspectionsSearchField').value;
            const term = document.getElementById('inspectionsSearchTerm').value.toLowerCase();
            let filtered = inspectionsData.filter(doc => {
                if (!term) return true;
                if (field && doc[field]) {
                    if (field.toLowerCase().includes('date')) {
                        return formatDateForDisplay(doc[field]).toLowerCase().includes(term);
                    }
                    return String(doc[field]).toLowerCase().includes(term);
                }
                return Object.values(doc).some(value => {
                    if (typeof value === 'string' && value.toLowerCase().includes('date')) {
                        return formatDateForDisplay(value || '').toLowerCase().includes(term);
                    }
                    return String(value || '').toLowerCase().includes(term);
                });
            });

            filtered.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA.getTime() !== dateB.getTime()) {
                    return dateA.getTime() - dateB.getTime();
                }
                const insNumComparison = String(a.ins_number || '').localeCompare(String(b.ins_number || ''));
                if (insNumComparison !== 0) {
                    return insNumComparison;
                }
                return compareRevisions(a.revision, b.revision);
            });
            filtered.forEach(doc => tableBody.appendChild(renderInspectionRow(doc, 'inspections')));
        }

        function clearInspectionsSearch() {
            document.getElementById('inspectionsSearchField').value = '';
            document.getElementById('inspectionsSearchTerm').value = '';
            performInspectionsSearch();
        }

        function performMirSearch() {
            const tableBody = document.querySelector('#mirTable tbody');
            tableBody.innerHTML = '';
            const field = document.getElementById('mirSearchField').value;
            const term = document.getElementById('mirSearchTerm').value.toLowerCase();
            let filtered = mirData.filter(doc => {
                if (!term) return true;
                if (field && doc[field]) {
                    if (field.toLowerCase().includes('date')) {
                        return formatDateForDisplay(doc[field]).toLowerCase().includes(term);
                    }
                    return String(doc[field]).toLowerCase().includes(term);
                }
                return Object.values(doc).some(value => {
                    if (typeof value === 'string' && value.toLowerCase().includes('date')) {
                        return formatDateForDisplay(value || '').toLowerCase().includes(term);
                    }
                    return String(value || '').toLowerCase().includes(term);
                });
            });

            filtered.sort((a, b) => {
                const dateA = new Date(a.mir_date);
                const dateB = new Date(b.mir_date);
                if (dateA.getTime() !== dateB.getTime()) {
                    return dateA.getTime() - dateB.getTime();
                }
                const mirNumComparison = String(a.mir_number || '').localeCompare(String(b.mir_number || ''));
                if (mirNumComparison !== 0) {
                    return mirNumComparison;
                }
                return compareRevisions(a.mir_revision, b.mir_revision);
            });
            filtered.forEach(doc => tableBody.appendChild(renderMirRow(doc, 'mir')));
        }

        function clearMirSearch() {
            document.getElementById('mirSearchField').value = '';
            document.getElementById('mirSearchTerm').value = '';
            performMirSearch();
        }

        function performNcrSearch() {
            const tableBody = document.querySelector('#ncrTable tbody');
            tableBody.innerHTML = '';
            const field = document.getElementById('ncrSearchField').value;
            const term = document.getElementById('ncrSearchTerm').value.toLowerCase();
            const groupedNCRS = {};
            ncrData.forEach(doc => {
                const refNumber = doc.ncr_ref_number;
                const discipline = doc.ncr_discipline;
                const groupKey = `${refNumber}-${discipline}`;
                if (!groupedNCRS[groupKey]) {
                    groupedNCRS[groupKey] = [];
                }
                groupedNCRS[groupKey].push(doc);
            });
            const ncrDataWithLifecycleStatus = [];
            for (const groupKey in groupedNCRS) {
                const group = groupedNCRS[groupKey];
                if (group.length === 0) continue;
                group.sort((a, b) => compareRevisions(a.ncr_rev_part_b, b.ncr_rev_part_b));
                const latestDoc = group[group.length - 1];
                group.forEach(doc => {
                    const newDoc = { ...doc };
                    newDoc.ncr_lifecycle_status = (newDoc.id === latestDoc.id) ? 'Latest' : 'Superseded';
                    ncrDataWithLifecycleStatus.push(newDoc);
                });
            }

            let filtered = ncrDataWithLifecycleStatus.filter(doc => {
                if (!term) return true;
                if (field && doc[field]) {
                    if (field.toLowerCase().includes('date')) {
                        return formatDateForDisplay(doc[field]).toLowerCase().includes(term);
                    }
                    return String(doc[field]).toLowerCase().includes(term);
                }
                return Object.values(doc).some(value => {
                    if (typeof value === 'string' && value.toLowerCase().includes('date')) {
                        return formatDateForDisplay(value || '').toLowerCase().includes(term);
                    }
                    return String(value || '').toLowerCase().includes(term);
                });
            });

            filtered.sort((a, b) => {
                const dateA = new Date(a.part_a_received_date);
                const dateB = new Date(b.part_a_received_date);

                if (dateA.getTime() !== dateB.getTime()) {
                    return dateA.getTime() - dateB.getTime();
                }

                const refComparison = String(a.ncr_ref_number || '').localeCompare(String(b.ncr_ref_number || ''));
                if (refComparison !== 0) {
                    return refComparison;
                }

                return compareRevisions(a.ncr_rev_part_b, b.ncr_rev_part_b);
            });
            filtered.forEach(doc => tableBody.appendChild(renderNcrRow(doc, 'ncr')));
        }

        function clearNcrSearch() {
            document.getElementById('ncrSearchField').value = '';
            document.getElementById('ncrSearchTerm').value = '';
            performNcrSearch();
        }

        let currentSubmissionFilterStatus = '';
        function searchSubmissionDocuments() {
            const tableBody = document.getElementById('submissionDocumentTable').querySelector('tbody');
            tableBody.innerHTML = '';
            const searchTerm = document.getElementById('submissionSearchInput').value.toLowerCase();
            let filtered = submissionData;
            if (currentSubmissionFilterStatus) {
                filtered = filtered.filter(doc => doc.status === currentSubmissionFilterStatus);
            }

            if (searchTerm) {
                filtered = filtered.filter(doc => {
                    return Object.values(doc).some(value => {
                        if (typeof value === 'string' && value.toLowerCase().includes('date')) {
                            return formatDateForDisplay(value || '').toLowerCase().includes(term);
                        }
                        return String(value || '').toLowerCase().includes(term);
                    });
                });
            }

            filtered.sort((a, b) => {
                const dateA = new Date(a.submitted_date);
                const dateB = new Date(b.submitted_date);
                if (dateA.getTime() !== dateB.getTime()) {
                    return dateA.getTime() - dateB.getTime();
                }
                return String(a.doc_number || '').localeCompare(String(b.doc_number || ''));
            });
            filtered.forEach(doc => tableBody.appendChild(renderSubmissionRow(doc, 'submissions')));
        }

        function clearSubmissionSearch() {
            document.getElementById('submissionSearchInput').value = '';
            currentSubmissionFilterStatus = '';
            searchSubmissionDocuments();
        }

        function filterSubmissionByStatus(status) {
            currentSubmissionFilterStatus = status;
            searchSubmissionDocuments();
        }


        let currentOutgoingFilterStatus = '';
        let currentOutgoingKeywordFilter = '';
        function searchOutgoingCorrespondences() {
            const tableBody = document.querySelector('#outgoingCorrespondenceTable tbody');
            tableBody.innerHTML = '';
            const searchTerm = document.getElementById('outgoingSearchInput').value.toLowerCase();
            let filtered = outgoingCorrespondenceData;
            if (currentOutgoingFilterStatus) {
                filtered = filtered.filter(doc => doc.status === currentOutgoingFilterStatus);
            }
            if (currentOutgoingKeywordFilter) {
                filtered = filtered.filter(doc => doc.keyword === currentOutgoingKeywordFilter);
            }
            if (searchTerm) {
                filtered = filtered.filter(doc => {
                    return Object.values(doc).some(value => {
                        if (typeof value === 'string' && value.toLowerCase().includes('date')) {
                            return formatDateForDisplay(value || '').toLowerCase().includes(term);
                        }
                        return String(value || '').toLowerCase().includes(term);
                    });
                });
            }

            filtered.sort((a, b) => {
                const dateA = new Date(a.letter_date);
                const dateB = new Date(b.letter_date);
                if (dateA.getTime() !== dateB.getTime()) {
                    return dateA.getTime() - dateB.getTime();
                }
                return String(a.letter_ref || '').localeCompare(String(b.letter_ref || ''));
            });
            filtered.forEach(doc => tableBody.appendChild(renderOutgoingCorrespondenceRow(doc, 'outgoing_correspondences')));
        }

        function clearOutgoingSearch() {
            document.getElementById('outgoingSearchInput').value = '';
            document.getElementById('outgoingKeywordFilter').value = '';
            currentOutgoingFilterStatus = '';
            currentOutgoingKeywordFilter = '';
            searchOutgoingCorrespondences();
        }

        function filterOutgoingByStatus(status) {
            currentOutgoingFilterStatus = status;
            searchOutgoingCorrespondences();
        }

        function filterOutgoingByKeyword(keyword) {
            currentOutgoingKeywordFilter = keyword;
            searchOutgoingCorrespondences();
        }


        let currentIncomingFilterStatus = '';
        let currentIncomingKeywordFilter = '';
        function searchIncomingCorrespondences() {
            const tableBody = document.querySelector('#incomingCorrespondenceTable tbody');
            tableBody.innerHTML = '';
            const searchTerm = document.getElementById('incomingSearchInput').value.toLowerCase();
            let filtered = incomingCorrespondenceData;
            if (currentIncomingFilterStatus) {
                filtered = filtered.filter(doc => doc.status === currentIncomingFilterStatus);
            }
            if (currentIncomingKeywordFilter) {
                filtered = filtered.filter(doc => doc.keyword === currentIncomingKeywordFilter);
            }
            if (searchTerm) {
                filtered = filtered.filter(doc => {
                    return Object.values(doc).some(value => {
                        if (typeof value === 'string' && value.toLowerCase().includes('date')) {
                            return formatDateForDisplay(value || '').toLowerCase().includes(term);
                        }
                        return String(value || '').toLowerCase().includes(term);
                    });
                });
            }

            filtered.sort((a, b) => {
                const dateA = new Date(a.date_of_receipt);
                const dateB = new Date(b.date_of_receipt);
                if (dateA.getTime() !== dateB.getTime()) {
                    return dateA.getTime() - dateB.getTime();
                }
                return String(a.incoming_ref || '').localeCompare(String(b.incoming_ref || ''));
            });
            filtered.forEach(doc => tableBody.appendChild(renderIncomingCorrespondenceRow(doc, 'incoming_correspondences')));
        }

        function clearIncomingSearch() {
            document.getElementById('incomingSearchInput').value = '';
            document.getElementById('incomingKeywordFilter').value = '';
            currentIncomingFilterStatus = '';
            currentIncomingKeywordFilter = '';
            searchIncomingCorrespondences();
        }

        function filterIncomingByStatus(status) {
            currentIncomingFilterStatus = status;
            searchIncomingCorrespondences();
        }

        function filterIncomingByKeyword(keyword) {
            currentIncomingKeywordFilter = keyword;
            searchIncomingCorrespondences();
        }


        // --- CSV Download Functions ---

        function downloadCSV(data, filename, headers) {
            if (!data || data.length === 0) {
                showMessageModal("No data to download. Please add some records first.", "No Data");
                return;
            }

            let csv = headers.map(header => `"${header}"`).join(',') + '\n';
            data.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header];

                    if (header.toLowerCase().includes('date') && typeof value === 'string') {
                        value = formatDateForDisplay(value);
                    }

                    let stringValue = String(value || '');

                    stringValue = stringValue.replace(/"/g, '""');

                    return `"${stringValue}"`;
                });
                csv += values.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        const CORRESPONDENCE_CSV_HEADERS = [
            'Type', 'Reference', 'Date', 'From', 'To', 'Subject',
            'Reply_Reference', 'Keyword', 'Reply_Required', 'Date_Sent', 'Status'
        ];
        
        function downloadInspectionsCSV() {
            downloadCSV(inspectionsData, 'inspections_register.csv', [
                'date', 'discipline', 'ins_number', 'revision', 'location',
                'work_to_be_inspected', 'inspection_date', 'inspection_time',
                'approved_drawing_ref', 'specification_ref', 'approved_method_statement_ref',
                'qcs_reference', 'comment_received_date', 'document_status', 'rev_status',
                'approval_summary_status'
            ]);
        }

        function downloadMirCSV() {
            downloadCSV(mirData, 'mir_register.csv', [
                'mir_date', 'mir_discipline', 'mir_number', 'mir_revision', 'date_material_received',
                'mir_inspection_date', 'mir_inspection_time', 'material_approval_ref', 'description_material',
                'delivery_note_number', 'manufacturer', 'supplier', 'country_origin',
                'mir_submission_date', 'mir_response_date', 'mir_approval_status', 'mir_rev_status',
                'mir_approval_summary_status'
            ]);
        }

        function downloadNcrCSV() {
            const groupedNCRS = {};
            ncrData.forEach(doc => {
                const refNumber = doc.ncr_ref_number;
                const discipline = doc.ncr_discipline;
                const groupKey = `${refNumber}-${doc.ncr_discipline}`;
                if (!groupedNCRS[groupKey]) {
                    groupedNCRS[groupKey] = [];
                }
                groupedNCRS[groupKey].push(doc);
            });
            const ncrDataWithLifecycleStatus = [];
            for (const groupKey in groupedNCRS) {
                const group = groupedNCRS[groupKey];
                if (group.length === 0) continue;
                group.sort((a, b) => compareRevisions(a.ncr_rev_part_b, b.ncr_rev_part_b));
                const latestDoc = group[group.length - 1];
                group.forEach(doc => {
                    const newDoc = { ...doc };
                    newDoc.ncr_lifecycle_status = (newDoc.id === latestDoc.id) ? 'Latest' : 'Superseded';
                    ncrDataWithLifecycleStatus.push(newDoc);
                });
            }
            downloadCSV(ncrDataWithLifecycleStatus, 'ncr_register.csv', [
                'ncr_ref_number', 'ncr_discipline', 'ncr_lifecycle_status', 'ncr_description',
                'part_a_received_date', 'ncr_rev_part_b', 'ncr_revised_parts_part_b', 'immediate_action',
                'root_cause', 'corrective_action', 'part_b_submitted_date', 'part_c_received_date',
                'part_b_accepted_by_gec', 'if_part_b_accepted', 'part_d_rev', 'part_d_revised_parts',
                'part_d_submitted_date', 'part_e_received_date', 'part_e_status', 'ncr_current_status'
            ]);
        }

        function downloadSubmissionCSV() {
            downloadCSV(submissionData, 'submission_register.csv', [
                'doc_number', 'rev', 'discipline', 'doc_type', 'section', 'doc_title',
                'sub_ref', 'submitted_date', 'gec_due_date', 'responded_date', 'status',
                'verify_rev',
                'days_overdue'
            ]);
        }

        function prepareOutgoingForCSV() {
            return outgoingCorrespondenceData.map(doc => ({
                Type: 'Outgoing',
                Reference: doc.letter_ref || '',
                Date: doc.letter_date || '',
                From: doc.initiator || '',
                To: doc.addressee || '',
                Subject: doc.letter_subject || '',
                Reply_Reference: doc.in_reply_to_ref || '',
                Keyword: doc.keyword || '',
                Reply_Required: doc.reply_required || '',
                Date_Sent: doc.date_sent || '',
                Status: doc.status || ''
            }));
        }

        function prepareIncomingForCSV() {
            return incomingCorrespondenceData.map(doc => ({
                Type: 'Incoming',
                Reference: doc.incoming_ref || '',
                Date: doc.date_of_receipt || '',
                From: doc.originator || '',
                To: doc.addressee || '',
                Subject: doc.letter_subject || '',
                Reply_Reference: doc.reply_to_ref || '',
                Keyword: doc.keyword || '',
                Reply_Required: doc.reply_required || '',
                Date_Sent: '',
                Status: doc.status || ''
            }));
        }

        function downloadOutgoingCSV() {
            const dataToExport = prepareOutgoingForCSV();
            downloadCSV(dataToExport, 'outgoing_correspondence_register.csv', CORRESPONDENCE_CSV_HEADERS);
        }

        function downloadIncomingCSV() {
            const dataToExport = prepareIncomingForCSV();
            downloadCSV(dataToExport, 'incoming_correspondence_register.csv', CORRESPONDENCE_CSV_HEADERS);
        }

        // --- Pivot Table (Submission Register) ---

        function showPivotTableOptions() {
            document.getElementById('submissionTableContainer').classList.add('hidden');
            document.getElementById('pivotTableContainer').classList.remove('hidden');
            generatePivotTable();
        }

        function hidePivotTable() {
            document.getElementById('pivotTableContainer').classList.add('hidden');
            document.getElementById('submissionTableContainer').classList.remove('hidden');
        }

        function generatePivotTable() {
            const groupByField = document.getElementById('pivotGroupingSelect').value;
            const pivotTable = document.getElementById('pivotTable');
            pivotTable.innerHTML = '<thead></thead><tbody></tbody>';

            const groupedData = {};
            const statusMap = {
                'UR': 'Under Review',
                'C': 'Revised & Resubmit',
                'A': 'Approved',
                'B': 'Appr. w/ Comments',
                'D': 'Returned',
                'E': 'For Information',
                'X': 'Cancelled'
            };
            const statusesOrder = ['UR', 'C', 'A', 'B', 'D', 'E', 'X'];

            submissionData.forEach(doc => {
                const groupKey = doc[groupByField] || 'N/A';
                if (!groupedData[groupKey]) {
                    groupedData[groupKey] = {};
                    statusesOrder.forEach(status => groupedData[groupKey][status] = 0);
                    groupedData[groupKey].total = 0;
                }
                if (doc.status && statusesOrder.includes(doc.status)) {
                    groupedData[groupKey][doc.status]++;
                }
                groupedData[groupKey].total++;
            });
            const thead = pivotTable.querySelector('thead');
            let headerRow = `<tr><th>${groupByField.charAt(0).toUpperCase() + groupByField.slice(1)}</th>`;
            statusesOrder.forEach(status => {
                headerRow += `<th>${statusMap[status] || status}</th>`;
            });
            headerRow += `<th>Total</th></tr>`;
            thead.innerHTML = headerRow;

            const tbody = pivotTable.querySelector('tbody');
            for (const groupKey in groupedData) {
                let row = `<tr><td>${groupKey}</td>`;
                statusesOrder.forEach(status => {
                    row += `<td>${groupedData[groupKey][status]}</td>`;
                });
                row += `<td>${groupedData[groupKey].total}</td></tr>`;
                tbody.innerHTML += row;
            }
        }

        function downloadPivotTableCSV() {
            const groupByField = document.getElementById('pivotGroupingSelect').value;
            const statusMap = {
                'UR': 'Under Review',
                'C': 'Revised & Resubmit',
                'A': 'Approved',
                'B': 'Appr. w/ Comments',
                'D': 'Returned',
                'E': 'For Information',
                'X': 'Cancelled'
            };
            const statusesOrder = ['UR', 'C', 'A', 'B', 'D', 'E', 'X'];

            const groupedData = {};
            submissionData.forEach(doc => {
                const groupKey = doc[groupByField] || 'N/A';
                if (!groupedData[groupKey]) {
                    groupedData[groupKey] = {};
                    statusesOrder.forEach(status => groupedData[groupKey][status] = 0);
                    groupedData[groupKey].total = 0;
                }
                if (doc.status && statusesOrder.includes(doc.status)) {
                    groupedData[groupKey][doc.status]++;
                }
                groupedData[groupKey].total++;
            });
            let csvContent = `"${groupByField}",${statusesOrder.map(status => `"${statusMap[status] || status}"`).join(',')},"Total"\n`;
            for (const groupKey in groupedData) {
                const rowData = statusesOrder.map(status => groupedData[groupKey][status]);
                csvContent += `"${String(groupKey || '').replace(/"/g, '""')}",${rowData.join(',')},${groupedData[groupKey].total}\n`;
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'submission_pivot_table.csv');
            document.body.appendChild(link);
            link.removeChild(link);
        }


        // --- Event Listeners and Initial Load ---

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded fired. Initializing UI elements and then Supabase.");

            populateFixedDropdowns();
            showPage('inspectionsPage');
            showCorrespondenceSection('outgoingCorrespondenceSection');

            document.getElementById('discipline').addEventListener('change', updateNextInsNumber);

            document.getElementById('mirDiscipline').addEventListener('change', updateNextMirNumber);

            document.getElementById('partBAcceptedByGEC').addEventListener('change', (e) => {
                if (e.target.value === 'Yes') {
                    document.getElementById('ifPartBAccepted').value = 'Submit Part D';
                    document.getElementById('partDRev').value = document.getElementById('ncrRev_PartB').value;
                    document.getElementById('partDRevisedParts').value = 'Part D only';
                } else if (e.target.value === 'No') {
                    document.getElementById('ifPartBAccepted').value = 'Resubmit Part B';
                    document.getElementById('partDRev').value = '';
                    document.getElementById('partDRevisedParts').value = '';
                } else {
                    document.getElementById('ifPartBAccepted').value = '';
                    document.getElementById('partDRev').value = '';
                    document.getElementById('partDRevisedParts').value = '';
                }
            });
            
            document.getElementById('newSubmittedDate').addEventListener('change', () => {
                const submittedDate = document.getElementById('newSubmittedDate').value;
                const respondedDate = document.getElementById('newRespondedDate').value;
                if (submittedDate) {
                    const subDateObj = new Date(submittedDate);
                    const dueDateObj = new Date(subDateObj);
                    dueDateObj.setDate(subDateObj.getDate() + 14);
                    document.getElementById('gecDueDate').value = dueDateObj.toISOString().split('T')[0];
                } else {
                    document.getElementById('gecDueDate').value = '';
                }
                document.getElementById('daysOverdue').value = calculateDaysOverdue(submittedDate, respondedDate);
            });
            document.getElementById('newRespondedDate').addEventListener('change', () => {
                const submittedDate = document.getElementById('newSubmittedDate').value;
                const respondedDate = document.getElementById('newRespondedDate').value;
                document.getElementById('daysOverdue').value = calculateDaysOverdue(submittedDate, respondedDate);
            });
            document.getElementById('newStatus').addEventListener('change', () => {
                const submittedDate = document.getElementById('newSubmittedDate').value;
                const respondedDate = document.getElementById('newRespondedDate').value;
                document.getElementById('daysOverdue').value = calculateDaysOverdue(submittedDate, respondedDate);
            });
            
            initializeSupabase();
        });


        window.showPage = showPage;
        window.handleCustomConfirm = handleCustomConfirm;
        window.showMessageModal = showMessageModal;
        window.hideMessageModal = hideMessageModal;
        window.showLoadingOverlay = showLoadingOverlay;
        window.hideLoadingOverlay = hideLoadingOverlay;
        window.showCustomConfirm = showCustomConfirm;

        window.toggleAuthMode = toggleAuthMode;
        window.handleAuthSubmit = handleAuthSubmit;
        window.handleSignOut = handleSignOut;
        window.showForgotPasswordModal = showForgotPasswordModal;
        window.hideForgotPasswordModal = hideForgotPasswordModal;
        window.sendPasswordReset = sendPasswordReset;

        window.showEmailModal = showEmailModal;
        window.hideEmailModal = hideEmailModal;
        window.sendEmailViaOutlook = sendEmailViaOutlook;

        window.addUpdateInspectionDocument = addUpdateInspectionDocument;
        window.clearInspectionsForm = clearInspectionsForm;
        window.editInspection = editInspection;
        window.performInspectionsSearch = performInspectionsSearch;
        window.clearInspectionsSearch = clearInspectionsSearch;
        window.downloadInspectionsCSV = downloadInspectionsCSV;

        window.addUpdateMirDocument = addUpdateMirDocument;
        window.clearMirForm = clearMirForm;
        window.editMir = editMir;
        window.performMirSearch = performMirSearch;
        window.clearMirSearch = clearMirSearch;
        window.downloadMirCSV = downloadMirCSV;

        window.handleNcrFormSubmission = handleNcrFormSubmission;
        window.clearNcrForm = clearNcrForm;
        window.editNcr = editNcr;
        window.performNcrSearch = performNcrSearch;
        window.autoFillNcrDetails = autoFillNcrDetails;
        window.clearNcrSearch = clearNcrSearch;
        window.downloadNcrCSV = downloadNcrCSV;

        window.addNewSubmissionDocument = addNewSubmissionDocument;
        window.clearNewSubmissionDocumentForm = clearNewSubmissionDocumentForm;
        window.editSubmission = editSubmission;
        window.searchSubmissionDocuments = searchSubmissionDocuments;
        window.clearSubmissionSearch = clearSubmissionSearch;
        window.filterSubmissionByStatus = filterSubmissionByStatus;
        window.downloadSubmissionCSV = downloadSubmissionCSV;
        window.showPivotTableOptions = showPivotTableOptions;
        window.hidePivotTable = hidePivotTable;
        window.generatePivotTable = generatePivotTable;
        window.downloadPivotTableCSV = downloadPivotTableCSV;

        window.showCorrespondenceSection = showCorrespondenceSection;
        window.addNewOutgoingCorrespondence = addNewOutgoingCorrespondence;
        window.clearNewOutgoingCorrespondenceForm = clearNewOutgoingCorrespondenceForm;
        window.editOutgoing = editOutgoing;
        window.searchOutgoingCorrespondences = searchOutgoingCorrespondences;
        window.clearOutgoingSearch = clearOutgoingSearch;
        window.filterOutgoingByStatus = filterOutgoingByStatus;
        window.filterOutgoingByKeyword = filterOutgoingByKeyword;
        window.downloadOutgoingCSV = downloadOutgoingCSV;

        window.addNewIncomingCorrespondence = addNewIncomingCorrespondence;
        window.clearNewIncomingCorrespondenceForm = clearNewIncomingCorrespondenceForm;
        window.editIncoming = editIncoming;
        window.searchIncomingCorrespondences = searchIncomingCorrespondences;
        window.clearIncomingSearch = clearIncomingSearch;
        window.filterIncomingByStatus = filterIncomingByStatus;
        window.filterIncomingByKeyword = filterIncomingByKeyword;
        window.downloadIncomingCSV = downloadIncomingCSV;

        window.addUpdateStaffEmail = addUpdateStaffEmail;
        window.editStaffEmail = editStaffEmail;
        window.deleteStaffEmail = deleteStaffEmail;
        window.clearStaffForm = clearStaffForm;
        window.renderStaffEmails = renderStaffEmails;
        
        window.toggleTableVisibility = toggleTableVisibility;
        window.deleteDocument = deleteDocument;
    </script>
</body>
</html>
